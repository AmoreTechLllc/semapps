import e,{useState as t,useMemo as r,useEffect as n,useCallback as a}from"react";import{useRecordContext as o,useTranslate as i,useDataProvider as l,getResources as c,useGetResourceLabel as u,linkToRecord as s,useRefresh as m,useNotify as f,Button as p,usePermissionsOptimized as d,ReferenceArrayField as b}from"react-admin";import{makeStyles as g,Box as h,Avatar as y,Chip as v,List as E,ListItem as w,ListItemAvatar as O,ListItemText as x,ListItemSecondaryAction as k,IconButton as j,CircularProgress as T,Dialog as C,DialogTitle as A,DialogContent as L,TextField as N,DialogActions as P}from"@material-ui/core";import S from"@material-ui/icons/Launch";import{Form as I,Field as F}from"react-final-form";import R from"@material-ui/icons/Add";import{useSelector as M,shallowEqual as D}from"react-redux";import W from"lodash.debounce";import B from"@material-ui/icons/Visibility";import U from"@material-ui/icons/Error";import{useDataServers as z,useDataModel as _}from"@semapps/semantic-data-provider";import q from"@material-ui/icons/Language";import G from"@material-ui/icons/GitHub";import{FiGitlab as H}from"react-icons/fi";function V(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function $(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?V(Object(r),!0).forEach((function(t){Q(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):V(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function J(e,t,r,n,a,o,i){try{var l=e[o](i),c=l.value}catch(e){return void r(e)}l.done?t(c):Promise.resolve(c).then(n,a)}function K(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){J(o,n,a,i,l,"next",e)}function l(e){J(o,n,a,i,l,"throw",e)}i(void 0)}))}}function Q(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function X(){return(X=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function Y(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function Z(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==r)return;var n,a,o=[],i=!0,l=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){l=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(l)throw a}}return o}(e,t)||te(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ee(e){return function(e){if(Array.isArray(e))return re(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||te(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function te(e,t){if(e){if("string"==typeof e)return re(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?re(e,t):void 0}}function re(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var ne=["label","defaultLabel","image","fallback","externalLink","labelColor","classes"],ae=g((function(e){return{parent:function(e){return $({position:"relative"},e.parent)},square:{width:"100%",paddingBottom:"100%",position:"relative"},avatar:{position:"absolute",top:0,bottom:0,width:"100%",height:"100%",borderRadius:"50%","& svg":{width:"55%",height:"55%"}},chip:{position:"absolute",bottom:-10,left:0,right:0,paddingTop:3,paddingBottom:3,paddingLeft:6,paddingRight:6,marginBottom:10,cursor:"pointer"},launchIcon:{width:14}}})),oe=function(){},ie=function(t){var r=t.label,n=t.defaultLabel,a=t.image,i=t.fallback,l=t.externalLink,c=t.labelColor,u=t.classes,s=Y(t,ne);u=ae(u);var m=o(),f=("function"==typeof r?r(m):m[r])||n,p="function"==typeof a?a(m):m[a],d="function"==typeof i?i(m):i;return e.createElement(h,{className:u.parent},e.createElement("div",{className:u.square},e.createElement(y,X({src:p||d,alt:f,fallback:d,className:u.avatar},s))),l?e.createElement(v,{color:c,className:u.chip,size:"small",label:f,deleteIcon:e.createElement(S,{className:u.launchIcon}),onDelete:oe}):e.createElement(v,{color:c,className:u.chip,size:"small",label:f}))};ie.defaultProps={labelColor:"secondary",externalLink:!1};var le=g((function(e){return{root:{width:"100%",maxWidth:"100%",backgroundColor:e.palette.background.paper,paddingTop:0,paddingBottom:0},primaryText:{width:"30%"},secondaryText:{fontStyle:"italic",color:"grey"}}})),ce=function(e,t){var r=t&&Object.values(t).find((function(t){return e.startsWith(t.baseUrl)}));return r?r.name:"Inconnu"},ue=function(a){var m,f=a.keyword,p=a.source,d=a.reference,b=a.appendLink,g=a.switchToCreate,v=le(),C=Z(t(!1),2),A=C[0],L=C[1],N=Z(t(!1),2),P=N[0],S=N[1],I=Z(t([]),2),F=I[0],q=I[1],G=i(),H=l(),V=z(),$=o(),J=M(c,D),K=r((function(){return J.find((function(e){return e.name===d}))}),[J,d]),Q=u(),X=_(d);if(X&&Object.keys(X).length>0&&(null==X||null===(m=X.fieldsMapping)||void 0===m||!m.title))throw new Error("No fieldsMapping.title config found for ".concat(d," dataModel"));var Y=r((function(){return W((function(e){var t;H.getList(d,{pagination:{page:1,perPage:100},sort:{field:null==X||null===(t=X.fieldsMapping)||void 0===t?void 0:t.title,order:"ASC"},filter:{q:e,_servers:"@all"}}).then((function(e){var t=e.data,r=$[p]?Array.isArray($[p])?$[p]:[$[p]]:[],n=t.filter((function(e){return!r.includes(e.id)}));q(n),S(!0),L(!1)})).catch((function(e){L(!1)}))}),700)}),[H,X,$,p,d,q,L,S]);return n((function(){if(f)return L(!0),S(!1),Y(f),function(){return Y.cancel()}}),[f,Y,L]),f?e.createElement(E,{dense:!0,className:v.root},P&&F.map((function(t){return e.createElement(w,{key:t.id,button:!0,onClick:function(){return b(t.id)}},e.createElement(O,null,e.createElement(y,null,e.createElement(K.icon))),e.createElement(x,{className:v.primaryText,primary:t[X.fieldsMapping.title]}),e.createElement(x,{className:v.secondaryText,primary:ce(t.id,V)}),e.createElement(k,null,e.createElement("a",{href:s("/"+d,t.id,"show"),target:"_blank",rel:"noopener noreferrer"},e.createElement(j,{edge:"end"},e.createElement(B,null)))))})),P&&0===F.length&&e.createElement(w,null,e.createElement(O,null,e.createElement(y,null,e.createElement(U,null))),e.createElement(x,{className:v.primaryText,primary:G("ra.navigation.no_results")})),P&&K.hasCreate&&e.createElement(w,{button:!0,onClick:g},e.createElement(O,null,e.createElement(y,null,e.createElement(R,null))),e.createElement(x,{className:v.primaryText,primary:G("ra.page.create",{name:Q(d,1)})})),A&&e.createElement(h,{display:"flex",alignItems:"center",justifyContent:"center",height:150},e.createElement(T,{size:60,thickness:6}))):null},se=["meta","input"],me=g((function(){return{title:{paddingBottom:8},actions:{padding:15},addForm:{paddingTop:0},listForm:{paddingLeft:8,paddingRight:8,paddingTop:0,paddingBottom:0,maxHeight:210}}})),fe=function(t){var r=t.meta,n=r.touched,a=r.error,o=t.input,i=Y(t,se);return e.createElement(N,X({error:!(!n||!a),helperText:n&&a},o,i,{fullWidth:!0}))},pe=function(r){var n=r.open,o=r.onClose,c=r.subjectUri,s=r.resource,d=r.source,b=r.reference,g=me(),h=Z(t(""),2),y=h[0],v=h[1],E=Z(t("find"),2),w=E[0],O=E[1],x=l(),k=i(),j=m(),T=f(),S=u(),M=_(b),D=a(function(){var e=K(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.getOne(s,{id:c});case 2:return r=e.sent,n=r.data,e.next=6,x.update(s,{id:c,data:$($({},n),{},Q({},d,n[d]?Array.isArray(n[d])?[].concat(ee(n[d]),[t]):[n[d],t]:t)),previousData:n});case 6:j(),o();case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[x,c,s,d,j,o]),W=a(function(){var e=K(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.create(b,{data:Q({},M.fieldsMapping.title,t.title)});case 2:return r=e.sent,n=r.data,e.next=6,D(n.id);case 6:T('La resource "'.concat(t.title,'" a été créée'),"success");case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[x,M,D,b,T]);return e.createElement(C,{fullWidth:!0,open:n,onClose:o},"find"===w?e.createElement(e.Fragment,null,e.createElement(A,{className:g.title},"Ajouter une relation"),e.createElement(L,{className:g.addForm},e.createElement(N,{autoFocus:!0,label:"Rechercher ou créer des "+S(b,2).toLowerCase(),variant:"filled",margin:"dense",value:y,onChange:function(e){return v(e.target.value)},fullWidth:!0})),e.createElement(L,{className:g.listForm},e.createElement(ue,{keyword:y,source:d,reference:b,appendLink:D,switchToCreate:function(){return O("create")}})),e.createElement(P,{className:g.actions},e.createElement(p,{label:"ra.action.close",variant:"text",onClick:o}))):e.createElement(I,{onSubmit:W,initialValues:{title:y},render:function(t){var r=t.handleSubmit,n=t.submitting;return e.createElement("form",{onSubmit:r},e.createElement(A,{className:g.title},k("ra.page.create",{name:S(b,1)})),e.createElement(L,{className:g.addForm},e.createElement(F,{autoFocus:!0,id:"title",name:"title",component:fe,label:"Titre",disabled:n,variant:"filled",margin:"dense"})),e.createElement(P,{className:g.actions},e.createElement(p,{label:"ra.action.create",variant:"contained",startIcon:e.createElement(R,null),type:"submit",disabled:n}),e.createElement(p,{label:"ra.action.close",variant:"text",onClick:o})))}}))},de=["record","reference","source","resource"],be=function(n){var a=n.record,o=n.reference,i=n.source,l=n.resource,c=Y(n,de),u=Z(t(!1),2),s=u[0],m=u[1],f=d(a.id).permissions,p=r((function(){return!!f&&f.some((function(e){return["acl:Append","acl:Write","acl:Control"].includes(e["acl:mode"])}))}),[f]);return null!=a&&a[i]&&(Array.isArray(a[i])||(a[i]=[a[i]]),a[i]=a[i].map((function(e){return e["@id"]||e.id||e}))),e.createElement(e.Fragment,null,e.createElement(b,X({record:a,reference:o,source:i,resource:l,appendLink:p?function(){return m(!0)}:void 0},c)),p&&s&&e.createElement(pe,{open:s,onClose:function(){return m(!1)},subjectUri:a.id,resource:l,source:i,reference:o}))};be.defaultProps={addLabel:!0};var ge=["source","domainMapping"],he={"github.com":{label:"GitHub",icon:e.createElement(G,null),color:"black",contrastText:"white"},"gitlab.com":{label:"GitLab",icon:e.createElement(H,null),color:"orange",contrastText:"black"},"opencollective.com":{label:"Open Collective",icon:e.createElement(y,{src:"https://opencollective.com/static/images/opencollective-icon.svg"}),color:"white",contrastText:"#297EFF"}},ye=g((function(e){return{link:{textDecoration:"unset","& :hover":{cursor:"pointer"}},chip:{paddingLeft:5,paddingRight:5,marginRight:5},label:{marginTop:-1}}})),ve=function(t){var r=t.source,n=t.domainMapping,a=Y(t,ge),i=$($({},he),n),l=o(),c=ye();return(l[r]?Array.isArray(l[r])?l[r]:[l[r]]:[]).map((function(t,r){t.startsWith("http")||(t="https://"+t);var n=new URL(t);if(!n)return null;var o=i[n.hostname]||{label:"Site web",icon:e.createElement(q,null),color:"#ea",contrastText:"black"};return e.createElement("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:c.link},e.createElement(v,X({icon:e.cloneElement(o.icon,{style:{color:o.contrastText}}),size:"small",label:o.label,classes:{root:c.chip,label:c.label},style:{color:o.contrastText,backgroundColor:o.color}},a)))}))};ve.defaultProps={addLabel:!0};export{ie as AvatarWithLabelField,ve as MultiUrlField,be as QuickAppendReferenceArrayField};
//# sourceMappingURL=index.es.js.map
