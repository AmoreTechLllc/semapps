import e,{useState as t,useMemo as r,useEffect as n,useCallback as a}from"react";import{useTranslate as o,useDataProvider as i,useRecordContext as l,getResources as c,useGetResourceLabel as u,linkToRecord as s,useRefresh as m,useNotify as f,Button as d,usePermissionsOptimized as p,ReferenceArrayField as b}from"react-admin";import{makeStyles as y,List as g,ListItem as h,ListItemAvatar as v,Avatar as E,ListItemText as w,ListItemSecondaryAction as O,IconButton as x,Box as j,CircularProgress as k,Dialog as A,DialogTitle as T,DialogContent as C,TextField as S,DialogActions as P,Chip as N}from"@material-ui/core";import{Form as L,Field as F}from"react-final-form";import I from"@material-ui/icons/Add";import{useSelector as M,shallowEqual as R}from"react-redux";import W from"lodash.debounce";import D from"@material-ui/icons/Visibility";import U from"@material-ui/icons/Error";import{useDataServers as B,useDataModel as G}from"@semapps/semantic-data-provider";import H from"@material-ui/icons/Language";import _ from"@material-ui/icons/GitHub";import{FiGitlab as z}from"react-icons/fi";function V(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function q(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?V(Object(r),!0).forEach((function(t){K(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):V(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function $(e,t,r,n,a,o,i){try{var l=e[o](i),c=l.value}catch(e){return void r(e)}l.done?t(c):Promise.resolve(c).then(n,a)}function J(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){$(o,n,a,i,l,"next",e)}function l(e){$(o,n,a,i,l,"throw",e)}i(void 0)}))}}function K(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Q(){return(Q=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function X(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function Y(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==r)return;var n,a,o=[],i=!0,l=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){l=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(l)throw a}}return o}(e,t)||ee(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Z(e){return function(e){if(Array.isArray(e))return te(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ee(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ee(e,t){if(e){if("string"==typeof e)return te(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?te(e,t):void 0}}function te(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var re=y((function(e){return{root:{width:"100%",maxWidth:"100%",backgroundColor:e.palette.background.paper,paddingTop:0,paddingBottom:0},primaryText:{width:"30%"},secondaryText:{fontStyle:"italic",color:"grey"}}})),ne=function(e,t){var r=t&&Object.values(t).find((function(t){return e.startsWith(t.baseUrl)}));return r?r.name:"Inconnu"},ae=function(a){var m,f=a.keyword,d=a.source,p=a.reference,b=a.appendLink,y=a.switchToCreate,A=re(),T=Y(t(!1),2),C=T[0],S=T[1],P=Y(t(!1),2),N=P[0],L=P[1],F=Y(t([]),2),H=F[0],_=F[1],z=o(),V=i(),q=B(),$=l(),J=M(c,R),K=r((function(){return J.find((function(e){return e.name===p}))}),[J,p]),Q=u(),X=G(p);if(X&&Object.keys(X).length>0&&(null==X||null===(m=X.fieldsMapping)||void 0===m||!m.title))throw new Error("No fieldsMapping.title config found for ".concat(p," dataModel"));var Z=r((function(){return W((function(e){var t;V.getList(p,{pagination:{page:1,perPage:100},sort:{field:null==X||null===(t=X.fieldsMapping)||void 0===t?void 0:t.title,order:"ASC"},filter:{q:e}}).then((function(e){var t=e.data,r=$[d]?Array.isArray($[d])?$[d]:[$[d]]:[],n=t.filter((function(e){return!r.includes(e.id)}));_(n),L(!0),S(!1)})).catch((function(e){S(!1)}))}),700)}),[V,X,$,d,p,_,S,L]);return n((function(){if(f)return S(!0),L(!1),Z(f),function(){return Z.cancel()}}),[f,Z,S]),f?e.createElement(g,{dense:!0,className:A.root},N&&H.map((function(t){return e.createElement(h,{key:t.id,button:!0,onClick:function(){return b(t.id)}},e.createElement(v,null,e.createElement(E,null,e.createElement(K.icon))),e.createElement(w,{className:A.primaryText,primary:t[X.fieldsMapping.title]}),e.createElement(w,{className:A.secondaryText,primary:ne(t.id,q)}),e.createElement(O,null,e.createElement("a",{href:s("/"+p,t.id,"show"),target:"_blank",rel:"noopener noreferrer"},e.createElement(x,{edge:"end"},e.createElement(D,null)))))})),N&&0===H.length&&e.createElement(h,null,e.createElement(v,null,e.createElement(E,null,e.createElement(U,null))),e.createElement(w,{className:A.primaryText,primary:z("ra.navigation.no_results")})),N&&K.hasCreate&&e.createElement(h,{button:!0,onClick:y},e.createElement(v,null,e.createElement(E,null,e.createElement(I,null))),e.createElement(w,{className:A.primaryText,primary:z("ra.page.create",{name:Q(p,1)})})),C&&e.createElement(j,{display:"flex",alignItems:"center",justifyContent:"center",height:150},e.createElement(k,{size:60,thickness:6}))):null},oe=["meta","input"],ie=y((function(){return{title:{paddingBottom:8},actions:{padding:15},addForm:{paddingTop:0},listForm:{paddingLeft:8,paddingRight:8,paddingTop:0,paddingBottom:0,maxHeight:210}}})),le=function(t){var r=t.meta,n=r.touched,a=r.error,o=t.input,i=X(t,oe);return e.createElement(S,Q({error:!(!n||!a),helperText:n&&a},o,i,{fullWidth:!0}))},ce=function(r){var n=r.open,l=r.onClose,c=r.subjectUri,s=r.resource,p=r.source,b=r.reference,y=ie(),g=Y(t(""),2),h=g[0],v=g[1],E=Y(t("find"),2),w=E[0],O=E[1],x=i(),j=o(),k=m(),N=f(),M=u(),R=G(b),W=a(function(){var e=J(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.getOne(s,{id:c});case 2:return r=e.sent,n=r.data,e.next=6,x.update(s,{id:c,data:q(q({},n),{},K({},p,n[p]?Array.isArray(n[p])?[].concat(Z(n[p]),[t]):[n[p],t]:t)),previousData:n});case 6:k(),l();case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[x,c,s,p,k,l]),D=a(function(){var e=J(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.create(b,{data:K({},R.fieldsMapping.title,t.title)});case 2:return r=e.sent,n=r.data,e.next=6,W(n.id);case 6:N('La resource "'.concat(t.title,'" a été créée'),"success");case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[x,R,W,b,N]);return e.createElement(A,{fullWidth:!0,open:n,onClose:l},"find"===w?e.createElement(e.Fragment,null,e.createElement(T,{className:y.title},"Ajouter une relation"),e.createElement(C,{className:y.addForm},e.createElement(S,{autoFocus:!0,label:"Rechercher ou créer des "+M(b,2).toLowerCase(),variant:"filled",margin:"dense",value:h,onChange:function(e){return v(e.target.value)},fullWidth:!0})),e.createElement(C,{className:y.listForm},e.createElement(ae,{keyword:h,source:p,reference:b,appendLink:W,switchToCreate:function(){return O("create")}})),e.createElement(P,{className:y.actions},e.createElement(d,{label:"ra.action.close",variant:"text",onClick:l}))):e.createElement(L,{onSubmit:D,initialValues:{title:h},render:function(t){var r=t.handleSubmit,n=t.submitting;return e.createElement("form",{onSubmit:r},e.createElement(T,{className:y.title},j("ra.page.create",{name:M(b,1)})),e.createElement(C,{className:y.addForm},e.createElement(F,{autoFocus:!0,id:"title",name:"title",component:le,label:"Titre",disabled:n,variant:"filled",margin:"dense"})),e.createElement(P,{className:y.actions},e.createElement(d,{label:"ra.action.create",variant:"contained",startIcon:e.createElement(I,null),type:"submit",disabled:n}),e.createElement(d,{label:"ra.action.close",variant:"text",onClick:l})))}}))},ue=["record","reference","source","resource"],se=function(n){var a=n.record,o=n.reference,i=n.source,l=n.resource,c=X(n,ue),u=Y(t(!1),2),s=u[0],m=u[1],f=p(a.id).permissions,d=r((function(){return!!f&&f.some((function(e){return["acl:Append","acl:Write","acl:Control"].includes(e["acl:mode"])}))}),[f]);return null!=a&&a[i]&&(Array.isArray(a[i])||(a[i]=[a[i]]),a[i]=a[i].map((function(e){return e["@id"]||e.id||e}))),e.createElement(e.Fragment,null,e.createElement(b,Q({record:a,reference:o,source:i,resource:l,appendLink:d?function(){return m(!0)}:void 0},c)),d&&s&&e.createElement(ce,{open:s,onClose:function(){return m(!1)},subjectUri:a.id,resource:l,source:i,reference:o}))};se.defaultProps={addLabel:!0};var me=["source","domainMapping"],fe={"github.com":{label:"GitHub",icon:e.createElement(_,null),color:"black",contrastText:"white"},"gitlab.com":{label:"GitLab",icon:e.createElement(z,null),color:"orange",contrastText:"black"}},de=y((function(e){return{link:{textDecoration:"unset","& :hover":{cursor:"pointer"}},chip:{paddingLeft:5,paddingRight:5,marginRight:5},label:{marginTop:-1}}})),pe=function(t){var r=t.source,n=t.domainMapping,a=X(t,me),o=q(q({},fe),n),i=l(),c=de();return(i[r]?Array.isArray(i[r])?i[r]:[i[r]]:[]).map((function(t){t.startsWith("http")||(t="https://"+t);var r=new URL(t);if(!r)return null;var n=o[r.hostname]||{label:"Site web",icon:e.createElement(H,null),color:"#ea",contrastText:"black"};return e.createElement("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:c.link},e.createElement(N,Q({icon:e.cloneElement(n.icon,{style:{color:n.contrastText}}),size:"small",label:n.label,classes:{root:c.chip,label:c.label},style:{color:n.contrastText,backgroundColor:n.color}},a)))}))};pe.defaultProps={addLabel:!0};export{pe as MultiUrlField,se as QuickAppendReferenceArrayField};
//# sourceMappingURL=index.es.js.map
