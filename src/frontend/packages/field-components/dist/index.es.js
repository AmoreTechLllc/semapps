import e,{useState as t,useMemo as r,useEffect as n,useCallback as a}from"react";import{useTranslate as o,useDataProvider as i,useRecordContext as l,getResources as c,useGetResourceLabel as u,linkToRecord as s,useRefresh as m,useNotify as f,Button as p,usePermissionsOptimized as d,ReferenceArrayField as b}from"react-admin";import{makeStyles as g,List as y,ListItem as h,ListItemAvatar as v,Avatar as E,ListItemText as w,ListItemSecondaryAction as O,IconButton as x,Box as j,CircularProgress as k,Dialog as T,DialogTitle as A,DialogContent as C,TextField as P,DialogActions as S,Chip as N}from"@material-ui/core";import{Form as F,Field as L}from"react-final-form";import I from"@material-ui/icons/Add";import{useSelector as R,shallowEqual as M}from"react-redux";import W from"lodash.debounce";import D from"@material-ui/icons/Visibility";import U from"@material-ui/icons/Error";import{useDataServers as B,useDataModel as G}from"@semapps/semantic-data-provider";import V from"@material-ui/icons/Language";import _ from"@material-ui/icons/Forum";import z from"@material-ui/icons/GitHub";import{FiGitlab as H}from"react-icons/fi";import q from"@material-ui/icons/VideocamOutlined";function $(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function J(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?$(Object(r),!0).forEach((function(t){X(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):$(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function K(e,t,r,n,a,o,i){try{var l=e[o](i),c=l.value}catch(e){return void r(e)}l.done?t(c):Promise.resolve(c).then(n,a)}function Q(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){K(o,n,a,i,l,"next",e)}function l(e){K(o,n,a,i,l,"throw",e)}i(void 0)}))}}function X(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Y(){return(Y=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function Z(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function ee(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==r)return;var n,a,o=[],i=!0,l=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){l=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(l)throw a}}return o}(e,t)||re(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function te(e){return function(e){if(Array.isArray(e))return ne(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||re(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function re(e,t){if(e){if("string"==typeof e)return ne(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ne(e,t):void 0}}function ne(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var ae=g((function(e){return{root:{width:"100%",maxWidth:"100%",backgroundColor:e.palette.background.paper,paddingTop:0,paddingBottom:0},primaryText:{width:"30%"},secondaryText:{fontStyle:"italic",color:"grey"}}})),oe=function(e,t){var r=t&&Object.values(t).find((function(t){return e.startsWith(t.baseUrl)}));return r?r.name:"Inconnu"},ie=function(a){var m,f=a.keyword,p=a.source,d=a.reference,b=a.appendLink,g=a.switchToCreate,T=ae(),A=ee(t(!1),2),C=A[0],P=A[1],S=ee(t(!1),2),N=S[0],F=S[1],L=ee(t([]),2),V=L[0],_=L[1],z=o(),H=i(),q=B(),$=l(),J=R(c,M),K=r((function(){return J.find((function(e){return e.name===d}))}),[J,d]),Q=u(),X=G(d);if(X&&Object.keys(X).length>0&&(null==X||null===(m=X.fieldsMapping)||void 0===m||!m.title))throw new Error("No fieldsMapping.title config found for ".concat(d," dataModel"));var Y=r((function(){return W((function(e){var t;H.getList(d,{pagination:{page:1,perPage:100},sort:{field:null==X||null===(t=X.fieldsMapping)||void 0===t?void 0:t.title,order:"ASC"},filter:{q:e}}).then((function(e){var t=e.data,r=$[p]?Array.isArray($[p])?$[p]:[$[p]]:[],n=t.filter((function(e){return!r.includes(e.id)}));_(n),F(!0),P(!1)})).catch((function(e){P(!1)}))}),700)}),[H,X,$,p,d,_,P,F]);return n((function(){if(f)return P(!0),F(!1),Y(f),function(){return Y.cancel()}}),[f,Y,P]),f?e.createElement(y,{dense:!0,className:T.root},N&&V.map((function(t){return e.createElement(h,{key:t.id,button:!0,onClick:function(){return b(t.id)}},e.createElement(v,null,e.createElement(E,null,e.createElement(K.icon))),e.createElement(w,{className:T.primaryText,primary:t[X.fieldsMapping.title]}),e.createElement(w,{className:T.secondaryText,primary:oe(t.id,q)}),e.createElement(O,null,e.createElement("a",{href:s("/"+d,t.id,"show"),target:"_blank",rel:"noopener noreferrer"},e.createElement(x,{edge:"end"},e.createElement(D,null)))))})),N&&0===V.length&&e.createElement(h,null,e.createElement(v,null,e.createElement(E,null,e.createElement(U,null))),e.createElement(w,{className:T.primaryText,primary:z("ra.navigation.no_results")})),N&&K.hasCreate&&e.createElement(h,{button:!0,onClick:g},e.createElement(v,null,e.createElement(E,null,e.createElement(I,null))),e.createElement(w,{className:T.primaryText,primary:z("ra.page.create",{name:Q(d,1)})})),C&&e.createElement(j,{display:"flex",alignItems:"center",justifyContent:"center",height:150},e.createElement(k,{size:60,thickness:6}))):null},le=["meta","input"],ce=g((function(){return{title:{paddingBottom:8},actions:{padding:15},addForm:{paddingTop:0},listForm:{paddingLeft:8,paddingRight:8,paddingTop:0,paddingBottom:0,maxHeight:210}}})),ue=function(t){var r=t.meta,n=r.touched,a=r.error,o=t.input,i=Z(t,le);return e.createElement(P,Y({error:!(!n||!a),helperText:n&&a},o,i,{fullWidth:!0}))},se=function(r){var n=r.open,l=r.onClose,c=r.subjectUri,s=r.resource,d=r.source,b=r.reference,g=ce(),y=ee(t(""),2),h=y[0],v=y[1],E=ee(t("find"),2),w=E[0],O=E[1],x=i(),j=o(),k=m(),N=f(),R=u(),M=G(b),W=a(function(){var e=Q(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.getOne(s,{id:c});case 2:return r=e.sent,n=r.data,e.next=6,x.update(s,{id:c,data:J(J({},n),{},X({},d,n[d]?Array.isArray(n[d])?[].concat(te(n[d]),[t]):[n[d],t]:t)),previousData:n});case 6:k(),l();case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[x,c,s,d,k,l]),D=a(function(){var e=Q(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.create(b,{data:X({},M.fieldsMapping.title,t.title)});case 2:return r=e.sent,n=r.data,e.next=6,W(n.id);case 6:N('La resource "'.concat(t.title,'" a été créée'),"success");case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[x,M,W,b,N]);return e.createElement(T,{fullWidth:!0,open:n,onClose:l},"find"===w?e.createElement(e.Fragment,null,e.createElement(A,{className:g.title},"Ajouter une relation"),e.createElement(C,{className:g.addForm},e.createElement(P,{autoFocus:!0,label:"Rechercher ou créer des "+R(b,2).toLowerCase(),variant:"filled",margin:"dense",value:h,onChange:function(e){return v(e.target.value)},fullWidth:!0})),e.createElement(C,{className:g.listForm},e.createElement(ie,{keyword:h,source:d,reference:b,appendLink:W,switchToCreate:function(){return O("create")}})),e.createElement(S,{className:g.actions},e.createElement(p,{label:"ra.action.close",variant:"text",onClick:l}))):e.createElement(F,{onSubmit:D,initialValues:{title:h},render:function(t){var r=t.handleSubmit,n=t.submitting;return e.createElement("form",{onSubmit:r},e.createElement(A,{className:g.title},j("ra.page.create",{name:R(b,1)})),e.createElement(C,{className:g.addForm},e.createElement(L,{autoFocus:!0,id:"title",name:"title",component:ue,label:"Titre",disabled:n,variant:"filled",margin:"dense"})),e.createElement(S,{className:g.actions},e.createElement(p,{label:"ra.action.create",variant:"contained",startIcon:e.createElement(I,null),type:"submit",disabled:n}),e.createElement(p,{label:"ra.action.close",variant:"text",onClick:l})))}}))},me=["record","reference","source","resource"],fe=function(n){var a=n.record,o=n.reference,i=n.source,l=n.resource,c=Z(n,me),u=ee(t(!1),2),s=u[0],m=u[1],f=d(a.id).permissions,p=r((function(){return!!f&&f.some((function(e){return["acl:Append","acl:Write","acl:Control"].includes(e["acl:mode"])}))}),[f]);return null!=a&&a[i]&&(Array.isArray(a[i])||(a[i]=[a[i]]),a[i]=a[i].map((function(e){return e["@id"]||e.id||e}))),e.createElement(e.Fragment,null,e.createElement(b,Y({record:a,reference:o,source:i,resource:l,appendLink:p?function(){return m(!0)}:void 0},c)),p&&s&&e.createElement(se,{open:s,onClose:function(){return m(!1)},subjectUri:a.id,resource:l,source:i,reference:o}))};fe.defaultProps={addLabel:!0};var pe=["source"],de={"forums.assemblee-virtuelle.org":{label:"Forum",icon:e.createElement(_,null),color:"#28ccfb",contrastText:"white"},"chat.lescommuns.org":{label:"Chat",icon:e.createElement(E,{src:"/lescommuns.jpg"}),color:"white",contrastText:"black"},"github.com":{label:"Github",icon:e.createElement(z,null),color:"black",contrastText:"white"},"gitlab.com":{label:"Gitlab",icon:e.createElement(H,null),color:"orange",contrastText:"black"},"opencollective.com":{label:"Open Collective",icon:e.createElement(E,{src:"https://opencollective.com/static/images/opencollective-icon.svg"}),color:"white",contrastText:"#297EFF"},"peertube.virtual-assembly.org":{label:"Peertube",icon:e.createElement(q,null),color:"white",contrastText:"#f2690d"}},be=g((function(e){return{link:{textDecoration:"unset","& :hover":{cursor:"pointer"}},chip:{paddingLeft:5,paddingRight:5,marginRight:5},label:{marginTop:-1}}})),ge=function(t){var r=t.source,n=Z(t,pe),a=l(),o=be();return(a[r]?Array.isArray(a[r])?a[r]:[a[r]]:[]).map((function(t){t.startsWith("http")||(t="https://"+t);var r=new URL(t);if(!r)return null;var a=de[r.hostname]||{label:"Site web",icon:e.createElement(V,null),color:"#ea",contrastText:"black"};return e.createElement("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:o.link},e.createElement(N,Y({icon:e.cloneElement(a.icon,{style:{color:a.contrastText}}),size:"small",label:a.label,classes:{root:o.chip,label:o.label},style:{color:a.contrastText,backgroundColor:a.color}},n)))}))};ge.defaultProps={addLabel:!0};export{ge as MultiUrlField,fe as QuickAppendReferenceArrayField};
//# sourceMappingURL=index.es.js.map
