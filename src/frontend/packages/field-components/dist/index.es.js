import e,{useState as t,useMemo as r,useEffect as n,useCallback as a}from"react";import{useTranslate as o,useDataProvider as i,useRecordContext as l,getResources as c,useGetResourceLabel as u,linkToRecord as s,useRefresh as m,useNotify as f,Button as p,usePermissionsOptimized as d,ReferenceArrayField as y}from"react-admin";import{makeStyles as b,List as g,ListItem as h,ListItemAvatar as v,Avatar as E,ListItemText as O,ListItemSecondaryAction as w,IconButton as x,Box as j,CircularProgress as k,Dialog as C,DialogTitle as A,DialogContent as T,TextField as P,DialogActions as N,Chip as S}from"@material-ui/core";import{Form as L,Field as F}from"react-final-form";import I from"@material-ui/icons/Add";import{useSelector as M,shallowEqual as R}from"react-redux";import W from"lodash.debounce";import z from"@material-ui/icons/Visibility";import D from"@material-ui/icons/Error";import{useDataServers as U,useDataModel as B}from"@semapps/semantic-data-provider";import G from"@material-ui/icons/Language";import H from"@material-ui/icons/GitHub";function _(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function V(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?_(Object(r),!0).forEach((function(t){J(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):_(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function q(e,t,r,n,a,o,i){try{var l=e[o](i),c=l.value}catch(e){return void r(e)}l.done?t(c):Promise.resolve(c).then(n,a)}function $(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function i(e){q(o,n,a,i,l,"next",e)}function l(e){q(o,n,a,i,l,"throw",e)}i(void 0)}))}}function J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function K(){return(K=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function Q(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}function X(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==r)return;var n,a,o=[],i=!0,l=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);i=!0);}catch(e){l=!0,a=e}finally{try{i||null==r.return||r.return()}finally{if(l)throw a}}return o}(e,t)||Z(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Y(e){return function(e){if(Array.isArray(e))return ee(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Z(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Z(e,t){if(e){if("string"==typeof e)return ee(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ee(e,t):void 0}}function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var te=b((function(e){return{root:{width:"100%",maxWidth:"100%",backgroundColor:e.palette.background.paper,paddingTop:0,paddingBottom:0},primaryText:{width:"30%"},secondaryText:{fontStyle:"italic",color:"grey"}}})),re=function(e,t){var r=t&&Object.values(t).find((function(t){return e.startsWith(t.baseUrl)}));return r?r.name:"Inconnu"},ne=function(a){var m,f=a.keyword,p=a.source,d=a.reference,y=a.appendLink,b=a.switchToCreate,C=te(),A=X(t(!1),2),T=A[0],P=A[1],N=X(t(!1),2),S=N[0],L=N[1],F=X(t([]),2),G=F[0],H=F[1],_=o(),V=i(),q=U(),$=l(),J=M(c,R),K=r((function(){return J.find((function(e){return e.name===d}))}),[J,d]),Q=u(),Y=B(d);if(Y&&Object.keys(Y).length>0&&(null==Y||null===(m=Y.fieldsMapping)||void 0===m||!m.title))throw new Error("No fieldsMapping.title config found for ".concat(d," dataModel"));var Z=r((function(){return W((function(e){var t;V.getList(d,{pagination:{page:1,perPage:100},sort:{field:null==Y||null===(t=Y.fieldsMapping)||void 0===t?void 0:t.title,order:"ASC"},filter:{q:e}}).then((function(e){var t=e.data,r=$[p]?Array.isArray($[p])?$[p]:[$[p]]:[],n=t.filter((function(e){return!r.includes(e.id)}));H(n),L(!0),P(!1)})).catch((function(e){P(!1)}))}),700)}),[V,Y,$,p,d,H,P,L]);return n((function(){if(f)return P(!0),L(!1),Z(f),function(){return Z.cancel()}}),[f,Z,P]),f?e.createElement(g,{dense:!0,className:C.root},S&&G.map((function(t){return e.createElement(h,{key:t.id,button:!0,onClick:function(){return y(t.id)}},e.createElement(v,null,e.createElement(E,null,e.createElement(K.icon))),e.createElement(O,{className:C.primaryText,primary:t[Y.fieldsMapping.title]}),e.createElement(O,{className:C.secondaryText,primary:re(t.id,q)}),e.createElement(w,null,e.createElement("a",{href:s("/"+d,t.id,"show"),target:"_blank",rel:"noopener noreferrer"},e.createElement(x,{edge:"end"},e.createElement(z,null)))))})),S&&0===G.length&&e.createElement(h,null,e.createElement(v,null,e.createElement(E,null,e.createElement(D,null))),e.createElement(O,{className:C.primaryText,primary:_("ra.navigation.no_results")})),S&&K.hasCreate&&e.createElement(h,{button:!0,onClick:b},e.createElement(v,null,e.createElement(E,null,e.createElement(I,null))),e.createElement(O,{className:C.primaryText,primary:_("ra.page.create",{name:Q(d,1)})})),T&&e.createElement(j,{display:"flex",alignItems:"center",justifyContent:"center",height:150},e.createElement(k,{size:60,thickness:6}))):null},ae=["meta","input"],oe=b((function(){return{title:{paddingBottom:8},actions:{padding:15},addForm:{paddingTop:0},listForm:{paddingLeft:8,paddingRight:8,paddingTop:0,paddingBottom:0,maxHeight:210}}})),ie=function(t){var r=t.meta,n=r.touched,a=r.error,o=t.input,i=Q(t,ae);return e.createElement(P,K({error:!(!n||!a),helperText:n&&a},o,i,{fullWidth:!0}))},le=function(r){var n=r.open,l=r.onClose,c=r.subjectUri,s=r.resource,d=r.source,y=r.reference,b=oe(),g=X(t(""),2),h=g[0],v=g[1],E=X(t("find"),2),O=E[0],w=E[1],x=i(),j=o(),k=m(),S=f(),M=u(),R=B(y),W=a(function(){var e=$(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.getOne(s,{id:c});case 2:return r=e.sent,n=r.data,e.next=6,x.update(s,{id:c,data:V(V({},n),{},J({},d,n[d]?Array.isArray(n[d])?[].concat(Y(n[d]),[t]):[n[d],t]:t)),previousData:n});case 6:k(),l();case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[x,c,s,d,k,l]),z=a(function(){var e=$(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.create(y,{data:J({},R.fieldsMapping.title,t.title)});case 2:return r=e.sent,n=r.data,e.next=6,W(n.id);case 6:S('La resource "'.concat(t.title,'" a été créée'),"success");case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[x,R,W,y,S]);return e.createElement(C,{fullWidth:!0,open:n,onClose:l},"find"===O?e.createElement(e.Fragment,null,e.createElement(A,{className:b.title},"Ajouter une relation"),e.createElement(T,{className:b.addForm},e.createElement(P,{autoFocus:!0,label:"Rechercher ou créer des "+M(y,2).toLowerCase(),variant:"filled",margin:"dense",value:h,onChange:function(e){return v(e.target.value)},fullWidth:!0})),e.createElement(T,{className:b.listForm},e.createElement(ne,{keyword:h,source:d,reference:y,appendLink:W,switchToCreate:function(){return w("create")}})),e.createElement(N,{className:b.actions},e.createElement(p,{label:"ra.action.close",variant:"text",onClick:l}))):e.createElement(L,{onSubmit:z,initialValues:{title:h},render:function(t){var r=t.handleSubmit,n=t.submitting;return e.createElement("form",{onSubmit:r},e.createElement(A,{className:b.title},j("ra.page.create",{name:M(y,1)})),e.createElement(T,{className:b.addForm},e.createElement(F,{autoFocus:!0,id:"title",name:"title",component:ie,label:"Titre",disabled:n,variant:"filled",margin:"dense"})),e.createElement(N,{className:b.actions},e.createElement(p,{label:"ra.action.create",variant:"contained",startIcon:e.createElement(I,null),type:"submit",disabled:n}),e.createElement(p,{label:"ra.action.close",variant:"text",onClick:l})))}}))},ce=["record","reference","source","resource"],ue=function(n){var a=n.record,o=n.reference,i=n.source,l=n.resource,c=Q(n,ce),u=X(t(!1),2),s=u[0],m=u[1],f=d(a.id).permissions,p=r((function(){return!!f&&f.some((function(e){return["acl:Append","acl:Write","acl:Control"].includes(e["acl:mode"])}))}),[f]);return null!=a&&a[i]&&(Array.isArray(a[i])||(a[i]=[a[i]]),a[i]=a[i].map((function(e){return e["@id"]||e.id||e}))),e.createElement(e.Fragment,null,e.createElement(y,K({record:a,reference:o,source:i,resource:l,appendLink:p?function(){return m(!0)}:void 0},c)),p&&s&&e.createElement(le,{open:s,onClose:function(){return m(!1)},subjectUri:a.id,resource:l,source:i,reference:o}))};ue.defaultProps={addLabel:!0};var se={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},me=e.createContext&&e.createContext(se),fe=function(){return(fe=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},pe=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(n=Object.getOwnPropertySymbols(e);a<n.length;a++)t.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(e,n[a])&&(r[n[a]]=e[n[a]])}return r};function de(t){return function(r){return e.createElement(ye,fe({attr:fe({},t.attr)},r),function t(r){return r&&r.map((function(r,n){return e.createElement(r.tag,fe({key:n},r.attr),t(r.child))}))}(t.child))}}function ye(t){var r=function(r){var n,a=t.attr,o=t.size,i=t.title,l=pe(t,["attr","size","title"]),c=o||r.size||"1em";return r.className&&(n=r.className),t.className&&(n=(n?n+" ":"")+t.className),e.createElement("svg",fe({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},r.attr,a,l,{className:n,style:fe(fe({color:t.color||r.color},r.style),t.style),height:c,width:c,xmlns:"http://www.w3.org/2000/svg"}),i&&e.createElement("title",null,i),t.children)};return void 0!==me?e.createElement(me.Consumer,null,(function(e){return r(e)})):r(se)}function be(e){return de({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"}}]})(e)}var ge=["source","domainMapping"],he={"github.com":{label:"GitHub",icon:e.createElement(H,null),color:"black",contrastText:"white"},"gitlab.com":{label:"GitLab",icon:e.createElement(be,null),color:"orange",contrastText:"black"},"opencollective.com":{label:"Open Collective",icon:e.createElement(E,{src:"https://opencollective.com/static/images/opencollective-icon.svg"}),color:"white",contrastText:"#297EFF"}},ve=b((function(e){return{link:{textDecoration:"unset","& :hover":{cursor:"pointer"}},chip:{paddingLeft:5,paddingRight:5,marginRight:5},label:{marginTop:-1}}})),Ee=function(t){var r=t.source,n=t.domainMapping,a=Q(t,ge),o=V(V({},he),n),i=l(),c=ve();return(i[r]?Array.isArray(i[r])?i[r]:[i[r]]:[]).map((function(t,r){t.startsWith("http")||(t="https://"+t);var n=new URL(t);if(!n)return null;var i=o[n.hostname]||{label:"Site web",icon:e.createElement(G,null),color:"#ea",contrastText:"black"};return e.createElement("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:c.link},e.createElement(S,K({icon:e.cloneElement(i.icon,{style:{color:i.contrastText}}),size:"small",label:i.label,classes:{root:c.chip,label:c.label},style:{color:i.contrastText,backgroundColor:i.color}},a)))}))};Ee.defaultProps={addLabel:!0};export{Ee as MultiUrlField,ue as QuickAppendReferenceArrayField};
//# sourceMappingURL=index.es.js.map
