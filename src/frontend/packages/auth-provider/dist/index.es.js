import e,{createElement as t,cloneElement as r,forwardRef as n}from"react";import{useNotify as o,useLogin as i,Notification as a,useLogout as c,MenuItemLink as l,useGetIdentity as u,UserMenu as m}from"react-admin";import{ThemeProvider as s}from"@material-ui/styles";import{makeStyles as f,createMuiTheme as d}from"@material-ui/core/styles";import{Card as p,Avatar as g,CardActions as h,Button as w}from"@material-ui/core";import v from"@material-ui/icons/Lock";import y from"@material-ui/core/MenuItem";import k from"@material-ui/icons/PowerSettingsNew";import I from"@material-ui/icons/AccountCircle";import b from"@material-ui/icons/Edit";function C(e){this.message=e}C.prototype=new Error,C.prototype.name="InvalidCharacterError";var E="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new C("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,n,o=0,i=0,a="";n=t.charAt(i++);~n&&(r=o%4?64*r+n:n,o++%4)?a+=String.fromCharCode(255&r>>(-2*o&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return a};function S(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(E(e).replace(/(.)/g,(function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch(e){return E(t)}}function P(e){this.message=e}P.prototype=new Error,P.prototype.name="InvalidTokenError";var x=function(e){return{login:function(t){return window.location.href="".concat(e,"auth?redirectUrl=")+encodeURIComponent(window.location.href),Promise.resolve()},logout:function(){var t=new URL(window.location.href);return window.location.href="".concat(e,"auth/logout?redirectUrl=")+encodeURIComponent(t.origin+"/login?logout"),Promise.resolve("/")},checkAuth:function(){return localStorage.getItem("token"),Promise.resolve()},checkError:function(e){return Promise.resolve()},getPermissions:function(e){return Promise.resolve()},getIdentity:function(){var e=localStorage.getItem("token");if(e){var t=function(e,t){if("string"!=typeof e)throw new P("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(S(e.split(".")[r]))}catch(e){throw new P("Invalid token specified: "+e.message)}}(e);return{id:t.webId,fullName:t.name}}}}},U=f((function(e){return{main:{display:"flex",flexDirection:"column",minHeight:"100vh",alignItems:"center",justifyContent:"flex-start",backgroundColor:e.palette.primary[500]},card:{minWidth:300,marginTop:"6em"},lockIconAvatar:{margin:"1em",display:"flex",justifyContent:"center"},lockIcon:{backgroundColor:e.palette.secondary[500]}}})),O=function(e){var n=e.theme,c=e.history,l=e.location,u=e.buttons,m=U(),f=o(),w=i(),y=new URLSearchParams(l.search);return y.has("token")&&(localStorage.setItem("token",y.get("token")),f("Vous êtes maintenant connecté","info"),c.push("/")),y.has("logout")&&(localStorage.removeItem("token"),f("Vous êtes maintenant déconnecté","info"),c.push("/")),t(s,{theme:d(n)},t("div",{className:m.main},t(p,{className:m.card},t("div",{className:m.lockIconAvatar},t(g,{className:m.lockIcon},t(v,null))),u&&u.map((function(e){return t(h,null,r(e,{fullWidth:!0,variant:"outlined",type:"submit",onClick:function(){return w({},"/login")}}))})))),t(a,null))};O.defaultProps={buttons:[t(w,{startIcon:t(g,{src:"/lescommuns.jpg"})},"Les Communs")]};var j=n((function(t,r){var n=c();return e.createElement(y,{onClick:function(){return n()},ref:r},e.createElement(k,null),"   Se déconnecter")}));function N(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var R=n((function(t,r){var n=t.onClick,o=t.webId;return e.createElement(l,{ref:r,to:"/Person/".concat(encodeURIComponent(o),"/show"),primaryText:"Voir mon profil",leftIcon:e.createElement(I,null),onClick:n})})),A=n((function(t,r){var n=t.onClick,o=t.webId;return e.createElement(l,{ref:r,to:"/Person/".concat(encodeURIComponent(o),"/edit"),primaryText:"Editer mon profil",leftIcon:e.createElement(b,null),onClick:n})})),T=n((function(t,r){var n=t.onClick;return e.createElement(l,{ref:r,to:"/login",primaryText:"Se connecter",onClick:n})})),L=function(t){var r=t.logout,n=N(t,["logout"]),o=u().identity;return e.createElement(m,n,o&&""!==o.id?[e.createElement(R,{webId:o.id,key:"view"}),e.createElement(A,{webId:o.id,key:"edit"}),e.cloneElement(r,{key:"logout"})]:e.createElement(T,null))};export{O as LoginPage,j as LogoutButton,L as UserMenu,x as authProvider};
