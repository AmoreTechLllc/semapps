import e,{useState as t,useEffect as r,useCallback as n,forwardRef as o}from"react";import{useTranslate as a,useGetList as i,useDataProvider as c,Loading as s,Error as u,usePermissionsOptimized as l,useAuthProvider as f,Button as p,ListButton as d,ShowButton as m,useRecordContext as h,DeleteButton as v,Toolbar as g,SaveButton as b,useNotify as y,useRedirect as _,Edit as w,EditButton as j,Show as E,useLogin as O,Notification as k,useLogout as P,Resource as A,MenuItemLink as C,useGetIdentity as x,UserMenu as S,useSafeSetState as I,useGetPermissions as R}from"react-admin";import{TopToolbar as T,List as U,ListActions as z}from"@semapps/archipelago-layout";import N from"@material-ui/icons/Share";import{makeStyles as L,TextField as V,List as W,ListItem as M,ListItemAvatar as F,Avatar as $,ListItemText as D,ListItemSecondaryAction as B,IconButton as G,Menu as q,MenuItem as J,ListItemIcon as H,Dialog as K,DialogTitle as Q,DialogContent as X,DialogActions as Y,Card as Z,CardActions as ee,Button as te}from"@material-ui/core";import re from"@material-ui/lab/Autocomplete";import ne from"@material-ui/icons/Person";import oe from"@material-ui/icons/Edit";import ae from"@material-ui/icons/Check";import ie from"@material-ui/icons/Public";import ce from"@material-ui/icons/VpnLock";import se from"@material-ui/icons/Group";import{ThemeProvider as ue}from"@material-ui/styles";import{makeStyles as le,createMuiTheme as fe}from"@material-ui/core/styles";import pe from"@material-ui/icons/Lock";import de from"@material-ui/core/MenuItem";import me from"@material-ui/icons/PowerSettingsNew";import he from"@material-ui/icons/AccountCircle";function ve(e,t,r,n,o,a,i){try{var c=e[a](i),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,o)}function ge(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){ve(a,n,o,i,c,"next",e)}function c(e){ve(a,n,o,i,c,"throw",e)}i(void 0)}))}}function be(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ye(){return(ye=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function _e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function we(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?_e(Object(r),!0).forEach((function(t){be(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):_e(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function je(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function Ee(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var r=[],n=!0,o=!1,a=void 0;try{for(var i,c=e[Symbol.iterator]();!(n=(i=c.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==c.return||c.return()}finally{if(o)throw a}}return r}(e,t)||ke(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Oe(e){return function(e){if(Array.isArray(e))return Pe(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||ke(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ke(e,t){if(e){if("string"==typeof e)return Pe(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Pe(e,t):void 0}}function Pe(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Ae(e){this.message=e}Ae.prototype=new Error,Ae.prototype.name="InvalidCharacterError";var Ce="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new Ae("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,n,o=0,a=0,i="";n=t.charAt(a++);~n&&(r=o%4?64*r+n:n,o++%4)?i+=String.fromCharCode(255&r>>(-2*o&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return i};function xe(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(Ce(e).replace(/(.)/g,(function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch(e){return Ce(t)}}function Se(e){this.message=e}function Ie(e,t){if("string"!=typeof e)throw new Se("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(xe(e.split(".")[r]))}catch(e){throw new Se("Invalid token specified: "+e.message)}}Se.prototype=new Error,Se.prototype.name="InvalidTokenError";var Re="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Te(e,t){return e(t={exports:{}},t.exports),t.exports}var Ue,ze,Ne=Te((function(e){var t,r;t=Re,r=function(){function e(e){var t=[];if(0===e.length)return"";if("string"!=typeof e[0])throw new TypeError("Url must be a string. Received "+e[0]);if(e[0].match(/^[^/:]+:\/*$/)&&e.length>1){var r=e.shift();e[0]=r+e[0]}e[0].match(/^file:\/\/\//)?e[0]=e[0].replace(/^([^/:]+):\/*/,"$1:///"):e[0]=e[0].replace(/^([^/:]+):\/*/,"$1://");for(var n=0;n<e.length;n++){var o=e[n];if("string"!=typeof o)throw new TypeError("Url must be a string. Received "+o);""!==o&&(n>0&&(o=o.replace(/^[\/]+/,"")),o=n<e.length-1?o.replace(/[\/]+$/,""):o.replace(/[\/]+$/,"/"),t.push(o))}var a=t.join("/"),i=(a=a.replace(/\/(\?|&|#[^!])/g,"$1")).split("?");return a=i.shift()+(i.length>0?"?":"")+i.join("&")}return function(){return e("object"==typeof arguments[0]?arguments[0]:[].slice.call(arguments))}},e.exports?e.exports=r():t.urljoin=r()})),Le=function(e){return e?Array.isArray(e)?e:[e]:void 0},Ve=function(e,t){return Ne(e,t.replace(e,"_acl/"))},We=function(e){return{"@base":e,acl:"http://www.w3.org/ns/auth/acl#",foaf:"http://xmlns.com/foaf/0.1/","acl:agent":{"@type":"@id"},"acl:agentGroup":{"@type":"@id"},"acl:agentClass":{"@type":"@id"},"acl:mode":{"@type":"@id"},"acl:accessTo":{"@type":"@id"}}},Me=function(e){var t,r,n,o,a,i,c=e.middlewareUri,s=e.allowAnonymous,u=void 0===s||s,l=e.checkUser,f=e.httpClient,p=e.checkPermissions,d=e.resources;return{login:(i=ge(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=new URL(window.location.href),window.location.href="".concat(c,"auth?redirectUrl=")+encodeURIComponent(r.origin+"/login?login=true");case 2:case"end":return e.stop()}}),e)}))),function(e){return i.apply(this,arguments)}),logout:(a=ge(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=new URL(window.location.href),u){e.next=6;break}localStorage.removeItem("token"),window.location.href="".concat(c,"auth/logout?redirectUrl=")+encodeURIComponent(t.origin+"/login"),e.next=8;break;case 6:return window.location.href="".concat(c,"auth/logout?redirectUrl=")+encodeURIComponent(t.origin+"/login?logout=true"),e.abrupt("return","/");case 8:case"end":return e.stop()}}),e)}))),function(){return a.apply(this,arguments)}),checkAuth:(o=ge(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(localStorage.getItem("token")||u){e.next=3;break}throw new Error;case 3:case"end":return e.stop()}}),e)}))),function(){return o.apply(this,arguments)}),checkUser:function(e){return!l||l(e)},checkError:function(e){return Promise.resolve()},getPermissions:(n=ge(regeneratorRuntime.mark((function e(t){var r,n,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(p){e.next=2;break}return e.abrupt("return",!0);case 2:return r=d[t]?d[t].containerUri:t,n=Ve(c,r),e.next=6,f(n);case 6:return o=e.sent,a=o.json,e.abrupt("return",a["@graph"]);case 9:case"end":return e.stop()}}),e)}))),function(e){return n.apply(this,arguments)}),addPermission:(r=ge(regeneratorRuntime.mark((function e(t,r,n,o){var a,i,s,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=d[t]?d[t].containerUri:t,s=Ve(c,i),be(a={"@id":"#"+o.replace("acl:",""),"@type":"acl:Authorization"},n,r),be(a,"acl:accessTo",i),be(a,"acl:mode",o),u=a,e.next=5,f(s,{method:"PATCH",body:JSON.stringify({"@context":We(s),"@graph":[u]})});case 5:case"end":return e.stop()}}),e)}))),function(e,t,n,o){return r.apply(this,arguments)}),removePermission:(t=ge(regeneratorRuntime.mark((function e(t,r,n,o){var a,i,s,u,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=d[t]?d[t].containerUri:t,i=Ve(c,a),e.next=4,f(i);case 4:return s=e.sent,u=s.json,l=u["@graph"].filter((function(e){return!e["@id"].includes("#Default")})).map((function(e){var t=Le(e["acl:mode"]),a=Le(e[n]);return o&&t.includes(o)&&a&&a.includes(r)&&(a=a.filter((function(e){return e!==r}))),we(we({},e),{},be({},n,a))})),e.next=9,f(i,{method:"PUT",body:JSON.stringify({"@context":We(i),"@graph":l})});case 9:case"end":return e.stop()}}),e)}))),function(e,r,n,o){return t.apply(this,arguments)}),getIdentity:function(){var e=localStorage.getItem("token");if(e){var t=Ie(e);return{id:t.webId,fullName:t.name}}}}},Fe="acl:agentClass",$e=["acl:Append","acl:Write","acl:Control"],De=["acl:Append","acl:Write","acl:Control"],Be=["acl:Write","acl:Control"],Ge=["acl:Control"],qe={show:["acl:Read","acl:Append","acl:Write","acl:Control"],list:["acl:Read","acl:Append","acl:Write","acl:Control"],create:$e,edit:De,delete:Be,control:Ge},Je={show:"auth.message.resource_show_forbidden",edit:"auth.message.resource_edit_forbidden",delete:"auth.message.resource_delete_forbidden",control:"auth.message.resource_control_forbidden",list:"auth.message.container_list_forbidden",create:"auth.message.container_create_forbidden"},He=(be(Ue={},"acl:Read","auth.right.resource.read"),be(Ue,"acl:Append","auth.right.resource.append"),be(Ue,"acl:Write","auth.right.resource.write"),be(Ue,"acl:Control","auth.right.resource.control"),Ue),Ke=(be(ze={},"acl:Read","auth.right.container.read"),be(ze,"acl:Write","auth.right.container.write"),be(ze,"acl:Control","auth.right.container.control"),ze),Qe=L((function(){return{list:{padding:0,width:"100%"},option:{padding:0}}})),Xe=function(n){var o=n.agents,c=n.addPermission,s=Qe(),u=a(),l=Ee(t(null),2),f=l[0],p=l[1],d=Ee(t(""),2),m=d[0],h=d[1],v=Ee(t([]),2),g=v[0],b=v[1],y=i("Person",{page:1,perPage:100},{field:"pair:label",order:"ASC"},{q:m},{enabled:m.length>0}),_=y.ids,w=y.data;return r((function(){b(_.length>0?Object.values(w):[])}),[_,w]),e.createElement(re,{classes:{option:s.option},getOptionLabel:function(e){return e["pair:label"]},filterOptions:function(e){return e.filter((function(e){return!Object.keys(o).includes(e.id)}))},options:g,noOptionsText:u("ra.navigation.no_results"),autoComplete:!0,blurOnSelect:!0,clearOnBlur:!0,disableClearable:!0,value:f,onChange:function(e,t){c(t.id||t["@id"],"acl:agent","acl:Read"),p(null),h(""),b([])},onInputChange:function(e,t){h(t)},renderInput:function(t){return e.createElement(V,ye({},t,{label:u("auth.input.agent_select"),variant:"filled",margin:"dense",fullWidth:!0}))},renderOption:function(t){return e.createElement(W,{dense:!0,className:s.list},e.createElement(M,{button:!0},e.createElement(F,null,e.createElement($,{src:t.image},e.createElement(ne,null))),e.createElement(D,{primary:t["pair:label"]})))}})},Ye=function(t){var r=t.agent;switch(r.predicate){case Fe:return"foaf:Agent"===r.id?e.createElement(ie,null):e.createElement(ce,null);case"acl:agent":return e.createElement(ne,null);case"acl:agentGroup":return e.createElement(se,null);default:throw new Error("Unknown agent predicate: "+r.predicate)}},Ze=L((function(){return{listItem:{paddingLeft:4,paddingRight:36},primaryText:{width:"30%",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},secondaryText:{textAlign:"center",width:"60%",fontStyle:"italic",color:"grey"}}})),et=function(n){var o=n.isContainer,i=n.agent,l=n.addPermission,f=n.removePermission,p=Ze(),d=a(),m=c(),h=Ee(e.useState(null),2),v=h[0],g=h[1],b=Ee(t(),2),y=b[0],_=b[1],w=Ee(t(!0),2),j=w[0],E=w[1],O=Ee(t(),2),k=O[0],P=O[1];if(r((function(){"acl:agent"===i.predicate?m.getOne("Person",{id:i.id}).then((function(e){var t=e.data;_(t),E(!1)})).catch((function(e){P(e),E(!1)})):E(!1)}),[i.id,i.predicate]),"acl:agentGroup"===i.predicate)return null;var A=function(){return g(null)},C=o?Ke:He;return j?e.createElement(s,null):k?e.createElement(u,null):e.createElement(M,{className:p.listItem},e.createElement(F,null,e.createElement($,{src:null==y?void 0:y.image},e.createElement(Ye,{agent:i}))),e.createElement(D,{className:p.primaryText,primary:y?y["pair:label"]:d("foaf:Agent"===i.id?"auth.agent.anonymous":"auth.agent.authenticated")}),e.createElement(D,{className:p.secondaryText,primary:i.permissions&&i.permissions.map((function(e){return d(C[e])})).join(", ")}),e.createElement(B,null,e.createElement(G,{onClick:function(e){return g(e.currentTarget)}},e.createElement(oe,null)),e.createElement(q,{anchorEl:v,keepMounted:!0,open:Boolean(v),onClose:A},Object.entries(C).map((function(t){var r=Ee(t,2),n=r[0],o=r[1],a=i.permissions&&i.permissions.includes(n);return e.createElement(J,{key:n,onClick:function(){a?f(i.id,i.predicate,n):l(i.id,i.predicate,n),A()}},e.createElement(H,null,a?e.createElement(ae,null):null),e.createElement(D,{primary:d(o)}))})))))},tt=L((function(e){return{list:{width:"100%",maxWidth:"100%",backgroundColor:e.palette.background.paper}}})),rt=function(t){var r=t.isContainer,n=t.agents,o=t.addPermission,a=t.removePermission,i=tt();return e.createElement(W,{dense:!0,className:i.list},Object.entries(n).map((function(t){var n=Ee(t,2),i=n[0],c=n[1];return e.createElement(et,{key:i,isContainer:r,agent:c,addPermission:o,removePermission:a})})))},nt=function(e){var o=l(e).permissions,a=f(),i=Ee(t({}),2),c=i[0],s=i[1];r((function(){var e,t=(be(e={},"foaf:Agent",{id:"foaf:Agent",predicate:Fe,permissions:[]}),be(e,"acl:AuthenticatedAgent",{id:"acl:AuthenticatedAgent",predicate:Fe,permissions:[]}),e),r=function(e,r,n){t[e]?t[e].permissions.push(n):t[e]={id:e,predicate:r,permissions:[n]}};if(o){var n,a=function(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=ke(e))){var t=0,r=function(){};return{s:r,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o,a=!0,i=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return a=e.done,e},e:function(e){i=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(i)throw o}}}}(o);try{var i=function(){var e=n.value;e[Fe]&&Le(e[Fe]).forEach((function(t){return r(t,Fe,e["acl:mode"])})),e["acl:agent"]&&Le(e["acl:agent"]).forEach((function(t){return r(t,"acl:agent",e["acl:mode"])})),e["acl:agentGroup"]&&Le(e["acl:agentGroup"]).forEach((function(t){return r(t,"acl:agentGroup",e["acl:mode"])}))};for(a.s();!(n=a.n()).done;)i()}catch(e){a.e(e)}finally{a.f()}s(t)}}),[o]);var u=n((function(t,r,n){var o,i=we({},c);s(we(we({},c),{},be({},t,{id:t,predicate:r,permissions:c[t]?[].concat(Oe(null===(o=c[t])||void 0===o?void 0:o.permissions),[n]):[n]}))),a.addPermission(e,t,r,n).catch((function(e){s(i)}))}),[c,s,e,a]),p=n((function(t,r,n){var o=we({},c);s(Object.fromEntries(Object.entries(c).map((function(e){var r=Ee(e,2),o=r[0],a=r[1];return a.id===t&&(a.permissions=a.permissions.filter((function(e){return e!==n}))),[o,a]})).filter((function(e){var t=Ee(e,2),r=(t[0],t[1]);return r.predicate===Fe||r.permissions.length>0})))),a.removePermission(e,t,r,n).catch((function(e){s(o)}))}),[c,s,e,a]);return{agents:c,addPermission:u,removePermission:p}},ot=L((function(){return{title:{paddingBottom:8},actions:{padding:15},addForm:{paddingTop:0},listForm:{paddingTop:0,paddingBottom:0,paddingRight:0,maxHeight:210}}})),at=function(t){var r=t.open,n=t.onClose,o=t.resourceId,i=t.isContainer,c=ot(),s=a(),u=nt(o),l=u.agents,f=u.addPermission,d=u.removePermission;return e.createElement(K,{fullWidth:!0,open:r,onClose:n},e.createElement(Q,{className:c.title},s(i?"auth.dialog.container_permissions":"auth.dialog.resource_permissions")),e.createElement(X,{className:c.addForm},e.createElement(Xe,{agents:l,addPermission:f})),e.createElement(X,{className:c.listForm},e.createElement(rt,{isContainer:i,agents:l,addPermission:f,removePermission:d})),e.createElement(Y,{className:c.actions},e.createElement(p,{label:"ra.action.close",variant:"text",onClick:n})))},it=function(r){var n=r.record,o=r.resource,a=Ee(t(!1),2),i=a[0],c=a[1],s=!!o?o:n.id||n["@id"];return e.createElement(e.Fragment,null,e.createElement(p,{label:"auth.action.permissions",onClick:function(){return c(!0)}},e.createElement(N,null)),e.createElement(at,{resourceId:s,isContainer:!!o,open:i,onClose:function(){return c(!1)}}))},ct=function(t){var r=t.basePath,n=t.className,o=t.data,a=t.hasList,i=t.hasShow,c=t.hasControl,s=je(t,["basePath","className","data","hasList","hasShow","hasControl"]);return e.createElement(T,ye({className:n},s),a&&e.createElement(d,{basePath:r,record:o}),i&&e.createElement(m,{basePath:r,record:o}),o&&c&&e.createElement(it,{basePath:r,record:o}))},st=function(t){var r=h(),n=l(r.id).permissions;return n&&n.some((function(e){return Be.includes(e["acl:mode"])}))?e.createElement(v,t):null},ut=L((function(){return{toolbar:{flex:1,display:"flex",justifyContent:"space-between"}}})),lt=function(t){var r=ut();return e.createElement(g,ye({},t,{className:r.toolbar}),e.createElement(b,null),e.createElement(st,{undoable:!1}),"}")},ft=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"/",o=l(e),a=o.permissions,i=y(),c=_();return r((function(){a&&!a.some((function(e){return qe[t].includes(e["acl:mode"])}))&&(i(Je[t],"error"),c(n))}),[a,c,i]),a},pt=function(t){var r=ft(t.id,"edit");return e.createElement(w,ye({actions:e.createElement(ct,{hasControl:!!r&&r.some((function(e){return Ge.includes(e["acl:mode"])}))})},t,{permissions:r}),e.cloneElement(t.children,we({toolbar:e.createElement(lt,null)},t.children.props)))},dt=function(t){var r=t.actions,n=t.resource,o=t.hasCreate,a=je(t,["actions","resource","hasCreate"]),i=l(n).permissions;return e.createElement(U,ye({},a,{resource:n,hasCreate:o&&!!i&&i.some((function(e){return $e.includes(e["acl:mode"])})),actions:r&&i&&i.some((function(e){return Ge.includes(e["acl:mode"])}))?e.cloneElement(r,{bulkActions:e.createElement(it,null)}):r}))};dt.defaultProps={actions:e.createElement(z,null)};var mt=function(t){var r=t.basePath,n=t.className,o=t.data,a=t.hasList,i=t.hasEdit,c=t.hasControl,s=je(t,["basePath","className","data","hasList","hasEdit","hasControl"]);return e.createElement(T,ye({className:n},s),a&&e.createElement(d,{basePath:r,record:o}),i&&e.createElement(j,{basePath:r,record:o}),o&&c&&e.createElement(it,{basePath:r,record:o}))},ht=function(t){var r=l(t.id).permissions;return e.createElement(E,ye({actions:e.createElement(mt,{hasControl:!!r&&r.some((function(e){return Ge.includes(e["acl:mode"])}))})},t,{permissions:r,hasEdit:t.hasEdit&&!!r&&r.some((function(e){return De.includes(e["acl:mode"])}))}))},vt=le((function(e){return{main:{display:"flex",flexDirection:"column",minHeight:"100vh",alignItems:"center",justifyContent:"flex-start",backgroundColor:e.palette.primary[500]},card:{minWidth:300,marginTop:"6em"},lockIconAvatar:{margin:"1em",display:"flex",justifyContent:"center"},lockIcon:{backgroundColor:e.palette.secondary[500]}}})),gt=function(t){var n=t.theme,o=t.history,a=t.location,i=t.buttons,s=t.userResource,u=vt(),l=y(),p=O(),d=c(),m=f();return r((function(){ge(regeneratorRuntime.mark((function e(){var t,r,n,i,c,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=new URLSearchParams(a.search)).has("login")){e.next=14;break}if(!t.has("error")){e.next=6;break}"registration.not-allowed"===t.get("error")?l("auth.message.user_email_not_found","error"):l("auth.message.bad_request","error",{error:t.get("error")}),e.next=14;break;case 6:if(!t.has("token")){e.next=14;break}return r=t.get("token"),n=Ie(r),i=n.webId,e.next=11,d.getOne("Person",{id:i});case 11:c=e.sent,u=c.data,m.checkUser(u)?(localStorage.setItem("token",r),t.has("new")&&"true"===t.get("new")?(l("auth.message.new_user_created","info"),o.push("/"+s+"/"+encodeURIComponent(i)+"/edit")):(l("auth.message.user_connected","info"),o.push("/"))):(l("auth.message.user_not_allowed_to_login","error"),o.replace("/login"));case 14:t.has("logout")&&(localStorage.removeItem("token"),l("auth.message.user_disconnected","info"),o.push("/"));case 15:case"end":return e.stop()}}),e)})))()}),[a.search]),e.createElement(ue,{theme:fe(n)},e.createElement("div",{className:u.main},e.createElement(Z,{className:u.card},e.createElement("div",{className:u.lockIconAvatar},e.createElement($,{className:u.lockIcon},e.createElement(pe,null))),i&&i.map((function(t,r){return e.createElement(ee,{key:r},e.cloneElement(t,{fullWidth:!0,variant:"outlined",type:"submit",onClick:function(){return p({},"/login")}}))})))),e.createElement(k,null))};gt.defaultProps={buttons:[e.createElement(te,{startIcon:e.createElement($,{src:"/lescommuns.jpg"})},"Les Communs")],userResource:"Person"};var bt=o((function(t,r){var n=P();return e.createElement(de,{onClick:function(){return n()},ref:r},e.createElement(me,null),"   Se déconnecter")})),yt=function(t){var r=t.name,n=t.create,o=je(t,["name","create"]),a=l(r).permissions;return e.createElement(A,ye({},o,{name:r,create:a&&a.some((function(e){return $e.includes(e["acl:mode"])}))?n:void 0}))},_t=o((function(t,r){var n=t.onClick,o=t.webId;return e.createElement(C,{ref:r,to:"/Person/".concat(encodeURIComponent(o),"/show"),primaryText:"Voir mon profil",leftIcon:e.createElement(he,null),onClick:n})})),wt=o((function(t,r){var n=t.onClick,o=t.webId;return e.createElement(C,{ref:r,to:"/Person/".concat(encodeURIComponent(o),"/edit"),primaryText:"Editer mon profil",leftIcon:e.createElement(oe,null),onClick:n})})),jt=o((function(t,r){var n=t.onClick;return e.createElement(C,{ref:r,to:"/login",primaryText:"Se connecter",onClick:n})})),Et=function(t){var r=t.logout,n=je(t,["logout"]),o=x().identity;return e.createElement(S,n,o&&""!==o.id?[e.createElement(_t,{webId:o.id,key:"view"}),e.createElement(wt,{webId:o.id,key:"edit"}),e.cloneElement(r,{key:"logout"})]:e.createElement(jt,null))};var Ot=function(){this.__data__=[],this.size=0};var kt=function(e,t){return e===t||e!=e&&t!=t};var Pt=function(e,t){for(var r=e.length;r--;)if(kt(e[r][0],t))return r;return-1},At=Array.prototype.splice;var Ct=function(e){var t=this.__data__,r=Pt(t,e);return!(r<0)&&(r==t.length-1?t.pop():At.call(t,r,1),--this.size,!0)};var xt=function(e){var t=this.__data__,r=Pt(t,e);return r<0?void 0:t[r][1]};var St=function(e){return Pt(this.__data__,e)>-1};var It=function(e,t){var r=this.__data__,n=Pt(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this};function Rt(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}Rt.prototype.clear=Ot,Rt.prototype.delete=Ct,Rt.prototype.get=xt,Rt.prototype.has=St,Rt.prototype.set=It;var Tt=Rt;var Ut=function(){this.__data__=new Tt,this.size=0};var zt=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r};var Nt=function(e){return this.__data__.get(e)};var Lt=function(e){return this.__data__.has(e)},Vt="object"==typeof Re&&Re&&Re.Object===Object&&Re,Wt="object"==typeof self&&self&&self.Object===Object&&self,Mt=Vt||Wt||Function("return this")(),Ft=Mt.Symbol,$t=Object.prototype,Dt=$t.hasOwnProperty,Bt=$t.toString,Gt=Ft?Ft.toStringTag:void 0;var qt=function(e){var t=Dt.call(e,Gt),r=e[Gt];try{e[Gt]=void 0;var n=!0}catch(e){}var o=Bt.call(e);return n&&(t?e[Gt]=r:delete e[Gt]),o},Jt=Object.prototype.toString;var Ht=function(e){return Jt.call(e)},Kt=Ft?Ft.toStringTag:void 0;var Qt=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Kt&&Kt in Object(e)?qt(e):Ht(e)};var Xt=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};var Yt,Zt=function(e){if(!Xt(e))return!1;var t=Qt(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},er=Mt["__core-js_shared__"],tr=(Yt=/[^.]+$/.exec(er&&er.keys&&er.keys.IE_PROTO||""))?"Symbol(src)_1."+Yt:"";var rr=function(e){return!!tr&&tr in e},nr=Function.prototype.toString;var or=function(e){if(null!=e){try{return nr.call(e)}catch(e){}try{return e+""}catch(e){}}return""},ar=/^\[object .+?Constructor\]$/,ir=Function.prototype,cr=Object.prototype,sr=ir.toString,ur=cr.hasOwnProperty,lr=RegExp("^"+sr.call(ur).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var fr=function(e){return!(!Xt(e)||rr(e))&&(Zt(e)?lr:ar).test(or(e))};var pr=function(e,t){return null==e?void 0:e[t]};var dr=function(e,t){var r=pr(e,t);return fr(r)?r:void 0},mr=dr(Mt,"Map"),hr=dr(Object,"create");var vr=function(){this.__data__=hr?hr(null):{},this.size=0};var gr=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},br=Object.prototype.hasOwnProperty;var yr=function(e){var t=this.__data__;if(hr){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return br.call(t,e)?t[e]:void 0},_r=Object.prototype.hasOwnProperty;var wr=function(e){var t=this.__data__;return hr?void 0!==t[e]:_r.call(t,e)};var jr=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=hr&&void 0===t?"__lodash_hash_undefined__":t,this};function Er(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}Er.prototype.clear=vr,Er.prototype.delete=gr,Er.prototype.get=yr,Er.prototype.has=wr,Er.prototype.set=jr;var Or=Er;var kr=function(){this.size=0,this.__data__={hash:new Or,map:new(mr||Tt),string:new Or}};var Pr=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var Ar=function(e,t){var r=e.__data__;return Pr(t)?r["string"==typeof t?"string":"hash"]:r.map};var Cr=function(e){var t=Ar(this,e).delete(e);return this.size-=t?1:0,t};var xr=function(e){return Ar(this,e).get(e)};var Sr=function(e){return Ar(this,e).has(e)};var Ir=function(e,t){var r=Ar(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this};function Rr(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}Rr.prototype.clear=kr,Rr.prototype.delete=Cr,Rr.prototype.get=xr,Rr.prototype.has=Sr,Rr.prototype.set=Ir;var Tr=Rr;var Ur=function(e,t){var r=this.__data__;if(r instanceof Tt){var n=r.__data__;if(!mr||n.length<199)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new Tr(n)}return r.set(e,t),this.size=r.size,this};function zr(e){var t=this.__data__=new Tt(e);this.size=t.size}zr.prototype.clear=Ut,zr.prototype.delete=zt,zr.prototype.get=Nt,zr.prototype.has=Lt,zr.prototype.set=Ur;var Nr=zr;var Lr=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this};var Vr=function(e){return this.__data__.has(e)};function Wr(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new Tr;++t<r;)this.add(e[t])}Wr.prototype.add=Wr.prototype.push=Lr,Wr.prototype.has=Vr;var Mr=Wr;var Fr=function(e,t){for(var r=-1,n=null==e?0:e.length;++r<n;)if(t(e[r],r,e))return!0;return!1};var $r=function(e,t){return e.has(t)};var Dr=function(e,t,r,n,o,a){var i=1&r,c=e.length,s=t.length;if(c!=s&&!(i&&s>c))return!1;var u=a.get(e);if(u&&a.get(t))return u==t;var l=-1,f=!0,p=2&r?new Mr:void 0;for(a.set(e,t),a.set(t,e);++l<c;){var d=e[l],m=t[l];if(n)var h=i?n(m,d,l,t,e,a):n(d,m,l,e,t,a);if(void 0!==h){if(h)continue;f=!1;break}if(p){if(!Fr(t,(function(e,t){if(!$r(p,t)&&(d===e||o(d,e,r,n,a)))return p.push(t)}))){f=!1;break}}else if(d!==m&&!o(d,m,r,n,a)){f=!1;break}}return a.delete(e),a.delete(t),f},Br=Mt.Uint8Array;var Gr=function(e){var t=-1,r=Array(e.size);return e.forEach((function(e,n){r[++t]=[n,e]})),r};var qr=function(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r},Jr=Ft?Ft.prototype:void 0,Hr=Jr?Jr.valueOf:void 0;var Kr=function(e,t,r,n,o,a,i){switch(r){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!a(new Br(e),new Br(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return kt(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var c=Gr;case"[object Set]":var s=1&n;if(c||(c=qr),e.size!=t.size&&!s)return!1;var u=i.get(e);if(u)return u==t;n|=2,i.set(e,t);var l=Dr(c(e),c(t),n,o,a,i);return i.delete(e),l;case"[object Symbol]":if(Hr)return Hr.call(e)==Hr.call(t)}return!1};var Qr=function(e,t){for(var r=-1,n=t.length,o=e.length;++r<n;)e[o+r]=t[r];return e},Xr=Array.isArray;var Yr=function(e,t,r){var n=t(e);return Xr(e)?n:Qr(n,r(e))};var Zr=function(e,t){for(var r=-1,n=null==e?0:e.length,o=0,a=[];++r<n;){var i=e[r];t(i,r,e)&&(a[o++]=i)}return a};var en=function(){return[]},tn=Object.prototype.propertyIsEnumerable,rn=Object.getOwnPropertySymbols,nn=rn?function(e){return null==e?[]:(e=Object(e),Zr(rn(e),(function(t){return tn.call(e,t)})))}:en;var on=function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n};var an=function(e){return null!=e&&"object"==typeof e};var cn=function(e){return an(e)&&"[object Arguments]"==Qt(e)},sn=Object.prototype,un=sn.hasOwnProperty,ln=sn.propertyIsEnumerable,fn=cn(function(){return arguments}())?cn:function(e){return an(e)&&un.call(e,"callee")&&!ln.call(e,"callee")};var pn=function(){return!1},dn=Te((function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,o=n&&n.exports===r?Mt.Buffer:void 0,a=(o?o.isBuffer:void 0)||pn;e.exports=a})),mn=/^(?:0|[1-9]\d*)$/;var hn=function(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&mn.test(e))&&e>-1&&e%1==0&&e<t};var vn=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991},gn={};gn["[object Float32Array]"]=gn["[object Float64Array]"]=gn["[object Int8Array]"]=gn["[object Int16Array]"]=gn["[object Int32Array]"]=gn["[object Uint8Array]"]=gn["[object Uint8ClampedArray]"]=gn["[object Uint16Array]"]=gn["[object Uint32Array]"]=!0,gn["[object Arguments]"]=gn["[object Array]"]=gn["[object ArrayBuffer]"]=gn["[object Boolean]"]=gn["[object DataView]"]=gn["[object Date]"]=gn["[object Error]"]=gn["[object Function]"]=gn["[object Map]"]=gn["[object Number]"]=gn["[object Object]"]=gn["[object RegExp]"]=gn["[object Set]"]=gn["[object String]"]=gn["[object WeakMap]"]=!1;var bn=function(e){return an(e)&&vn(e.length)&&!!gn[Qt(e)]};var yn=function(e){return function(t){return e(t)}},_n=Te((function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,o=n&&n.exports===r&&Vt.process,a=function(){try{var e=n&&n.require&&n.require("util").types;return e||o&&o.binding&&o.binding("util")}catch(e){}}();e.exports=a})),wn=_n&&_n.isTypedArray,jn=wn?yn(wn):bn,En=Object.prototype.hasOwnProperty;var On=function(e,t){var r=Xr(e),n=!r&&fn(e),o=!r&&!n&&dn(e),a=!r&&!n&&!o&&jn(e),i=r||n||o||a,c=i?on(e.length,String):[],s=c.length;for(var u in e)!t&&!En.call(e,u)||i&&("length"==u||o&&("offset"==u||"parent"==u)||a&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||hn(u,s))||c.push(u);return c},kn=Object.prototype;var Pn=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||kn)};var An=function(e,t){return function(r){return e(t(r))}}(Object.keys,Object),Cn=Object.prototype.hasOwnProperty;var xn=function(e){if(!Pn(e))return An(e);var t=[];for(var r in Object(e))Cn.call(e,r)&&"constructor"!=r&&t.push(r);return t};var Sn=function(e){return null!=e&&vn(e.length)&&!Zt(e)};var In=function(e){return Sn(e)?On(e):xn(e)};var Rn=function(e){return Yr(e,In,nn)},Tn=Object.prototype.hasOwnProperty;var Un=function(e,t,r,n,o,a){var i=1&r,c=Rn(e),s=c.length;if(s!=Rn(t).length&&!i)return!1;for(var u=s;u--;){var l=c[u];if(!(i?l in t:Tn.call(t,l)))return!1}var f=a.get(e);if(f&&a.get(t))return f==t;var p=!0;a.set(e,t),a.set(t,e);for(var d=i;++u<s;){var m=e[l=c[u]],h=t[l];if(n)var v=i?n(h,m,l,t,e,a):n(m,h,l,e,t,a);if(!(void 0===v?m===h||o(m,h,r,n,a):v)){p=!1;break}d||(d="constructor"==l)}if(p&&!d){var g=e.constructor,b=t.constructor;g==b||!("constructor"in e)||!("constructor"in t)||"function"==typeof g&&g instanceof g&&"function"==typeof b&&b instanceof b||(p=!1)}return a.delete(e),a.delete(t),p},zn=dr(Mt,"DataView"),Nn=dr(Mt,"Promise"),Ln=dr(Mt,"Set"),Vn=dr(Mt,"WeakMap"),Wn=or(zn),Mn=or(mr),Fn=or(Nn),$n=or(Ln),Dn=or(Vn),Bn=Qt;(zn&&"[object DataView]"!=Bn(new zn(new ArrayBuffer(1)))||mr&&"[object Map]"!=Bn(new mr)||Nn&&"[object Promise]"!=Bn(Nn.resolve())||Ln&&"[object Set]"!=Bn(new Ln)||Vn&&"[object WeakMap]"!=Bn(new Vn))&&(Bn=function(e){var t=Qt(e),r="[object Object]"==t?e.constructor:void 0,n=r?or(r):"";if(n)switch(n){case Wn:return"[object DataView]";case Mn:return"[object Map]";case Fn:return"[object Promise]";case $n:return"[object Set]";case Dn:return"[object WeakMap]"}return t});var Gn=Bn,qn=Object.prototype.hasOwnProperty;var Jn=function(e,t,r,n,o,a){var i=Xr(e),c=Xr(t),s=i?"[object Array]":Gn(e),u=c?"[object Array]":Gn(t),l="[object Object]"==(s="[object Arguments]"==s?"[object Object]":s),f="[object Object]"==(u="[object Arguments]"==u?"[object Object]":u),p=s==u;if(p&&dn(e)){if(!dn(t))return!1;i=!0,l=!1}if(p&&!l)return a||(a=new Nr),i||jn(e)?Dr(e,t,r,n,o,a):Kr(e,t,s,r,n,o,a);if(!(1&r)){var d=l&&qn.call(e,"__wrapped__"),m=f&&qn.call(t,"__wrapped__");if(d||m){var h=d?e.value():e,v=m?t.value():t;return a||(a=new Nr),o(h,v,r,n,a)}}return!!p&&(a||(a=new Nr),Un(e,t,r,n,o,a))};var Hn=function e(t,r,n,o,a){return t===r||(null==t||null==r||!an(t)&&!an(r)?t!=t&&r!=r:Jn(t,r,n,o,e,a))};var Kn=function(e,t){return Hn(e,t)},Qn={},Xn={"{}":void 0},Yn=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Qn,t=JSON.stringify(e),o=I({permissions:Xn[t]}),a=Ee(o,2),i=a[0],c=a[1],s=R(),u=n((function(){return s(e).then((function(e){Kn(e,i.permissions)||(Xn[t]=e,c({permissions:e}))})).catch((function(e){c({error:e})}))}),[t,e,s]);return r((function(){u()}),[t]),we(we({},i),{},{refetch:u})},Zn={auth:{dialog:{container_permissions:"Permissions sur le container",resource_permissions:"Permissions sur la resource"},action:{permissions:"Permissions"},right:{resource:{read:"Lire",append:"Enrichir",write:"Modifier",control:"Administrer"},container:{read:"Lister",append:"Ajouter",write:"Ajouter",control:"Administrer"}},agent:{anonymous:"Tous les utilisateurs",authenticated:"Utilisateurs connectés"},input:{agent_select:"Ajouter un utilisateur..."},message:{resource_show_forbidden:"Vous n'avez pas la permission de voir cette ressource",resource_edit_forbidden:"Vous n'avez pas la permission d'éditer cette ressource",resource_delete_forbidden:"Vous n'avez pas la permission d'effacer cette ressource",resource_control_forbidden:"Vous n'avez pas la permission d'administrer cette ressource",container_create_forbidden:"Vous n'avez pas la permission de créer des ressources",container_list_forbidden:"Vous n'avez pas la permission de voir ces ressources",user_not_allowed_to_login:"Vous n'avez pas le droit de vous connecter avec ce compte",user_email_not_found:"Aucun compte trouvé avec cette adresse mail",new_user_created:"Votre compte a été créé, vous pouvez maintenant le compléter",user_connected:"Vous êtes maintenant connecté",user_disconnected:"Vous êtes maintenant déconnecté",bad_request:"Requête erronée (Message d'erreur renvoyé par le serveur: %{error})"}}};export{st as DeleteButtonWithPermissions,ct as EditActions,lt as EditToolbarWithPermissions,pt as EditWithPermissions,dt as ListWithPermissions,gt as LoginPage,bt as LogoutButton,it as PermissionsButton,yt as ResourceWithPermissions,mt as ShowActions,ht as ShowWithPermissions,Et as UserMenu,Me as authProvider,Zn as frenchMessages,nt as useAgents,ft as useCheckPermissions,Yn as usePermissionsWithRefetch};
//# sourceMappingURL=index.es.js.map
