import e,{createElement as r,cloneElement as t,forwardRef as n,useMemo as o}from"react";import{useNotify as i,useLogin as a,Notification as c,useLogout as l,usePermissions as u,Resource as s,MenuItemLink as f,useGetIdentity as m,UserMenu as p}from"react-admin";import{ThemeProvider as d}from"@material-ui/styles";import{makeStyles as h,createMuiTheme as g}from"@material-ui/core/styles";import{Card as v,Avatar as w,CardActions as y,Button as b}from"@material-ui/core";import k from"@material-ui/icons/Lock";import I from"@material-ui/core/MenuItem";import C from"@material-ui/icons/PowerSettingsNew";import E from"@material-ui/icons/AccountCircle";import x from"@material-ui/icons/Edit";function P(e,r,t,n,o,i,a){try{var c=e[i](a),l=c.value}catch(e){return void t(e)}c.done?r(l):Promise.resolve(l).then(n,o)}function U(){return(U=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function j(e,r){if(null==e)return{};var t,n,o=function(e,r){if(null==e)return{};var t,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],r.indexOf(t)>=0||(o[t]=e[t]);return o}(e,r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}function S(e){this.message=e}S.prototype=new Error,S.prototype.name="InvalidCharacterError";var O="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var r=String(e).replace(/=+$/,"");if(r.length%4==1)throw new S("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,n,o=0,i=0,a="";n=r.charAt(i++);~n&&(t=o%4?64*t+n:n,o++%4)?a+=String.fromCharCode(255&t>>(-2*o&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return a};function R(e){var r=e.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(O(e).replace(/(.)/g,(function(e,r){var t=r.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t="0"+t),"%"+t})))}(r)}catch(e){return O(r)}}function T(e){this.message=e}T.prototype=new Error,T.prototype.name="InvalidTokenError";var A="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var N=function(e,r){return e(r={exports:{}},r.exports),r.exports}((function(e){var r,t;r=A,t=function(){function e(e){var r=[];if(0===e.length)return"";if("string"!=typeof e[0])throw new TypeError("Url must be a string. Received "+e[0]);if(e[0].match(/^[^/:]+:\/*$/)&&e.length>1){var t=e.shift();e[0]=t+e[0]}e[0].match(/^file:\/\/\//)?e[0]=e[0].replace(/^([^/:]+):\/*/,"$1:///"):e[0]=e[0].replace(/^([^/:]+):\/*/,"$1://");for(var n=0;n<e.length;n++){var o=e[n];if("string"!=typeof o)throw new TypeError("Url must be a string. Received "+o);""!==o&&(n>0&&(o=o.replace(/^[\/]+/,"")),o=n<e.length-1?o.replace(/[\/]+$/,""):o.replace(/[\/]+$/,"/"),r.push(o))}var i=r.join("/"),a=(i=i.replace(/\/(\?|&|#[^!])/g,"$1")).split("?");return i=a.shift()+(a.length>0?"?":"")+a.join("&")}return function(){return e("object"==typeof arguments[0]?arguments[0]:[].slice.call(arguments))}},e.exports?e.exports=t():r.urljoin=t()})),$=function(e){var r,t,n=e.middlewareUri,o=e.httpClient,i=e.checkPermissions,a=e.resources;return{login:function(e){return window.location.href="".concat(n,"auth?redirectUrl=")+encodeURIComponent(window.location.href),Promise.resolve()},logout:function(){var e=new URL(window.location.href);return window.location.href="".concat(n,"auth/logout?redirectUrl=")+encodeURIComponent(e.origin+"/login?logout"),Promise.resolve("/")},checkAuth:function(){return localStorage.getItem("token"),Promise.resolve()},checkError:function(e){return Promise.resolve()},getPermissions:(r=regeneratorRuntime.mark((function e(r){var t,c,l,u,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.resourceId,i){e.next=3;break}return e.abrupt("return",!0);case 3:return c=a[t].containerUri,l=N(n,c.replace(n,"_acl/")),e.next=7,o(l);case 7:return u=e.sent,s=u.json,e.abrupt("return",s["@graph"].map((function(e){return e["acl:mode"]})));case 10:case"end":return e.stop()}}),e)})),t=function(){var e=this,t=arguments;return new Promise((function(n,o){var i=r.apply(e,t);function a(e){P(i,n,o,a,c,"next",e)}function c(e){P(i,n,o,a,c,"throw",e)}a(void 0)}))},function(e){return t.apply(this,arguments)}),getIdentity:function(){var e=localStorage.getItem("token");if(e){var r=function(e,r){if("string"!=typeof e)throw new T("Invalid token specified");var t=!0===(r=r||{}).header?0:1;try{return JSON.parse(R(e.split(".")[t]))}catch(e){throw new T("Invalid token specified: "+e.message)}}(e);return{id:r.webId,fullName:r.name}}}}},W=h((function(e){return{main:{display:"flex",flexDirection:"column",minHeight:"100vh",alignItems:"center",justifyContent:"flex-start",backgroundColor:e.palette.primary[500]},card:{minWidth:300,marginTop:"6em"},lockIconAvatar:{margin:"1em",display:"flex",justifyContent:"center"},lockIcon:{backgroundColor:e.palette.secondary[500]}}})),L=function(e){var n=e.theme,o=e.history,l=e.location,u=e.buttons,s=W(),f=i(),m=a(),p=new URLSearchParams(l.search);return p.has("token")&&(localStorage.setItem("token",p.get("token")),f("Vous êtes maintenant connecté","info"),o.push("/")),p.has("logout")&&(localStorage.removeItem("token"),f("Vous êtes maintenant déconnecté","info"),o.push("/")),r(d,{theme:g(n)},r("div",{className:s.main},r(v,{className:s.card},r("div",{className:s.lockIconAvatar},r(w,{className:s.lockIcon},r(k,null))),u&&u.map((function(e){return r(y,null,t(e,{fullWidth:!0,variant:"outlined",type:"submit",onClick:function(){return m({},"/login")}}))})))),r(c,null))};L.defaultProps={buttons:[r(b,{startIcon:r(w,{src:"/lescommuns.jpg"})},"Les Communs")]};var V=n((function(r,t){var n=l();return e.createElement(I,{onClick:function(){return n()},ref:t},e.createElement(C,null),"   Se déconnecter")})),M=["acl:Read","acl:Append","acl:Write","acl:Control"],D=["acl:Append","acl:Write","acl:Control"],H=function(r){var t=r.name,n=r.list,i=r.create,a=j(r,["name","list","create"]),c=o((function(){return{resourceId:t}}),[t]),l=u(c).permissions;return e.createElement(s,U({},a,{name:t,list:l&&l.some((function(e){return M.includes(e)}))?n:void 0,create:l&&l.some((function(e){return D.includes(e)}))?i:void 0}))},J=n((function(r,t){var n=r.onClick,o=r.webId;return e.createElement(f,{ref:t,to:"/Person/".concat(encodeURIComponent(o),"/show"),primaryText:"Voir mon profil",leftIcon:e.createElement(E,null),onClick:n})})),_=n((function(r,t){var n=r.onClick,o=r.webId;return e.createElement(f,{ref:t,to:"/Person/".concat(encodeURIComponent(o),"/edit"),primaryText:"Editer mon profil",leftIcon:e.createElement(x,null),onClick:n})})),q=n((function(r,t){var n=r.onClick;return e.createElement(f,{ref:t,to:"/login",primaryText:"Se connecter",onClick:n})})),z=function(r){var t=r.logout,n=j(r,["logout"]),o=m().identity;return e.createElement(p,n,o&&""!==o.id?[e.createElement(J,{webId:o.id,key:"view"}),e.createElement(_,{webId:o.id,key:"edit"}),e.cloneElement(t,{key:"logout"})]:e.createElement(q,null))};export{L as LoginPage,V as LogoutButton,H as ResourceWithPermissions,z as UserMenu,$ as authProvider};
