import e,{createElement as t,cloneElement as r,forwardRef as n}from"react";import{useNotify as o,useLogin as i,Notification as a,useLogout as c,usePermissions as l,Resource as u,MenuItemLink as s,useGetIdentity as f,UserMenu as m}from"react-admin";import{ThemeProvider as p}from"@material-ui/styles";import{makeStyles as d,createMuiTheme as h}from"@material-ui/core/styles";import{Card as g,Avatar as v,CardActions as w,Button as y}from"@material-ui/core";import b from"@material-ui/icons/Lock";import k from"@material-ui/core/MenuItem";import I from"@material-ui/icons/PowerSettingsNew";import C from"@material-ui/icons/AccountCircle";import E from"@material-ui/icons/Edit";function x(e,t,r,n,o,i,a){try{var c=e[i](a),l=c.value}catch(e){return void r(e)}c.done?t(l):Promise.resolve(l).then(n,o)}function P(){return(P=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function U(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function j(e){this.message=e}j.prototype=new Error,j.prototype.name="InvalidCharacterError";var S="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new j("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,n,o=0,i=0,a="";n=t.charAt(i++);~n&&(r=o%4?64*r+n:n,o++%4)?a+=String.fromCharCode(255&r>>(-2*o&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return a};function O(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(S(e).replace(/(.)/g,(function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch(e){return S(t)}}function R(e){this.message=e}R.prototype=new Error,R.prototype.name="InvalidTokenError";var T="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var A=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,r;t=T,r=function(){function e(e){var t=[];if(0===e.length)return"";if("string"!=typeof e[0])throw new TypeError("Url must be a string. Received "+e[0]);if(e[0].match(/^[^/:]+:\/*$/)&&e.length>1){var r=e.shift();e[0]=r+e[0]}e[0].match(/^file:\/\/\//)?e[0]=e[0].replace(/^([^/:]+):\/*/,"$1:///"):e[0]=e[0].replace(/^([^/:]+):\/*/,"$1://");for(var n=0;n<e.length;n++){var o=e[n];if("string"!=typeof o)throw new TypeError("Url must be a string. Received "+o);""!==o&&(n>0&&(o=o.replace(/^[\/]+/,"")),o=n<e.length-1?o.replace(/[\/]+$/,""):o.replace(/[\/]+$/,"/"),t.push(o))}var i=t.join("/"),a=(i=i.replace(/\/(\?|&|#[^!])/g,"$1")).split("?");return i=a.shift()+(a.length>0?"?":"")+a.join("&")}return function(){return e("object"==typeof arguments[0]?arguments[0]:[].slice.call(arguments))}},e.exports?e.exports=r():t.urljoin=r()})),N=function(e){var t,r,n=e.middlewareUri,o=e.httpClient,i=e.checkPermissions,a=e.resources;return{login:function(e){return window.location.href="".concat(n,"auth?redirectUrl=")+encodeURIComponent(window.location.href),Promise.resolve()},logout:function(){var e=new URL(window.location.href);return window.location.href="".concat(n,"auth/logout?redirectUrl=")+encodeURIComponent(e.origin+"/login?logout"),Promise.resolve("/")},checkAuth:function(){return localStorage.getItem("token"),Promise.resolve()},checkError:function(e){return Promise.resolve()},getPermissions:(t=regeneratorRuntime.mark((function e(t){var r,c,l,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i){e.next=2;break}return e.abrupt("return",!0);case 2:return r=a[t]?a[t].containerUri:t,c=A(n,r.replace(n,"_acl/")),e.next=6,o(c);case 6:return l=e.sent,u=l.json,e.abrupt("return",u["@graph"].map((function(e){return e["acl:mode"]})));case 9:case"end":return e.stop()}}),e)})),r=function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(e){x(i,n,o,a,c,"next",e)}function c(e){x(i,n,o,a,c,"throw",e)}a(void 0)}))},function(e){return r.apply(this,arguments)}),getIdentity:function(){var e=localStorage.getItem("token");if(e){var t=function(e,t){if("string"!=typeof e)throw new R("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(O(e.split(".")[r]))}catch(e){throw new R("Invalid token specified: "+e.message)}}(e);return{id:t.webId,fullName:t.name}}}}},$=d((function(e){return{main:{display:"flex",flexDirection:"column",minHeight:"100vh",alignItems:"center",justifyContent:"flex-start",backgroundColor:e.palette.primary[500]},card:{minWidth:300,marginTop:"6em"},lockIconAvatar:{margin:"1em",display:"flex",justifyContent:"center"},lockIcon:{backgroundColor:e.palette.secondary[500]}}})),W=function(e){var n=e.theme,c=e.history,l=e.location,u=e.buttons,s=$(),f=o(),m=i(),d=new URLSearchParams(l.search);return d.has("token")&&(localStorage.setItem("token",d.get("token")),f("Vous êtes maintenant connecté","info"),c.push("/")),d.has("logout")&&(localStorage.removeItem("token"),f("Vous êtes maintenant déconnecté","info"),c.push("/")),t(p,{theme:h(n)},t("div",{className:s.main},t(g,{className:s.card},t("div",{className:s.lockIconAvatar},t(v,{className:s.lockIcon},t(b,null))),u&&u.map((function(e){return t(w,null,r(e,{fullWidth:!0,variant:"outlined",type:"submit",onClick:function(){return m({},"/login")}}))})))),t(a,null))};W.defaultProps={buttons:[t(y,{startIcon:t(v,{src:"/lescommuns.jpg"})},"Les Communs")]};var L=n((function(t,r){var n=c();return e.createElement(k,{onClick:function(){return n()},ref:r},e.createElement(I,null),"   Se déconnecter")})),V=["acl:Read","acl:Append","acl:Write","acl:Control"],M=["acl:Append","acl:Write","acl:Control"],D=function(t){var r=t.name,n=t.list,o=t.create,i=U(t,["name","list","create"]),a=l(r).permissions;return e.createElement(u,P({},i,{name:r,list:a&&a.some((function(e){return V.includes(e)}))?n:void 0,create:a&&a.some((function(e){return M.includes(e)}))?o:void 0}))},H=n((function(t,r){var n=t.onClick,o=t.webId;return e.createElement(s,{ref:r,to:"/Person/".concat(encodeURIComponent(o),"/show"),primaryText:"Voir mon profil",leftIcon:e.createElement(C,null),onClick:n})})),J=n((function(t,r){var n=t.onClick,o=t.webId;return e.createElement(s,{ref:r,to:"/Person/".concat(encodeURIComponent(o),"/edit"),primaryText:"Editer mon profil",leftIcon:e.createElement(E,null),onClick:n})})),_=n((function(t,r){var n=t.onClick;return e.createElement(s,{ref:r,to:"/login",primaryText:"Se connecter",onClick:n})})),q=function(t){var r=t.logout,n=U(t,["logout"]),o=f().identity;return e.createElement(m,n,o&&""!==o.id?[e.createElement(H,{webId:o.id,key:"view"}),e.createElement(J,{webId:o.id,key:"edit"}),e.cloneElement(r,{key:"logout"})]:e.createElement(_,null))};export{W as LoginPage,L as LogoutButton,D as ResourceWithPermissions,q as UserMenu,N as authProvider};
