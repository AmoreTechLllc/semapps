import e,{createElement as t,cloneElement as r,forwardRef as n}from"react";import{TopToolbar as o,ListButton as a,ShowButton as i,Toolbar as c,SaveButton as l,DeleteButton as s,usePermissions as u,Edit as m,useNotify as f,useLogin as d,Notification as p,useLogout as h,Resource as g,EditButton as v,Show as w,MenuItemLink as y,useGetIdentity as b,UserMenu as E}from"react-admin";import{makeStyles as k,Card as C,Avatar as I,CardActions as P,Button as x}from"@material-ui/core";import{ThemeProvider as S}from"@material-ui/styles";import{makeStyles as j,createMuiTheme as U}from"@material-ui/core/styles";import N from"@material-ui/icons/Lock";import O from"@material-ui/core/MenuItem";import R from"@material-ui/icons/PowerSettingsNew";import T from"@material-ui/icons/AccountCircle";import A from"@material-ui/icons/Edit";function L(e,t,r,n,o,a,i){try{var c=e[a](i),l=c.value}catch(e){return void r(e)}c.done?t(l):Promise.resolve(l).then(n,o)}function W(){return(W=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function $(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function D(e){this.message=e}D.prototype=new Error,D.prototype.name="InvalidCharacterError";var V="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new D("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,n,o=0,a=0,i="";n=t.charAt(a++);~n&&(r=o%4?64*r+n:n,o++%4)?i+=String.fromCharCode(255&r>>(-2*o&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return i};function M(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(V(e).replace(/(.)/g,(function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch(e){return V(t)}}function H(e){this.message=e}H.prototype=new Error,H.prototype.name="InvalidTokenError";var J="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var _=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,r;t=J,r=function(){function e(e){var t=[];if(0===e.length)return"";if("string"!=typeof e[0])throw new TypeError("Url must be a string. Received "+e[0]);if(e[0].match(/^[^/:]+:\/*$/)&&e.length>1){var r=e.shift();e[0]=r+e[0]}e[0].match(/^file:\/\/\//)?e[0]=e[0].replace(/^([^/:]+):\/*/,"$1:///"):e[0]=e[0].replace(/^([^/:]+):\/*/,"$1://");for(var n=0;n<e.length;n++){var o=e[n];if("string"!=typeof o)throw new TypeError("Url must be a string. Received "+o);""!==o&&(n>0&&(o=o.replace(/^[\/]+/,"")),o=n<e.length-1?o.replace(/[\/]+$/,""):o.replace(/[\/]+$/,"/"),t.push(o))}var a=t.join("/"),i=(a=a.replace(/\/(\?|&|#[^!])/g,"$1")).split("?");return a=i.shift()+(i.length>0?"?":"")+i.join("&")}return function(){return e("object"==typeof arguments[0]?arguments[0]:[].slice.call(arguments))}},e.exports?e.exports=r():t.urljoin=r()})),q=function(e){var t,r,n=e.middlewareUri,o=e.httpClient,a=e.checkPermissions,i=e.resources;return{login:function(e){return window.location.href="".concat(n,"auth?redirectUrl=")+encodeURIComponent(window.location.href),Promise.resolve()},logout:function(){var e=new URL(window.location.href);return window.location.href="".concat(n,"auth/logout?redirectUrl=")+encodeURIComponent(e.origin+"/login?logout"),Promise.resolve("/")},checkAuth:function(){return localStorage.getItem("token"),Promise.resolve()},checkError:function(e){return Promise.resolve()},getPermissions:(t=regeneratorRuntime.mark((function e(t){var r,c,l,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a){e.next=2;break}return e.abrupt("return",!0);case 2:return r=i[t]?i[t].containerUri:t,c=_(n,r.replace(n,"_acl/")),e.next=6,o(c);case 6:return l=e.sent,s=l.json,e.abrupt("return",s["@graph"].map((function(e){return e["acl:mode"]})));case 9:case"end":return e.stop()}}),e)})),r=function(){var e=this,r=arguments;return new Promise((function(n,o){var a=t.apply(e,r);function i(e){L(a,n,o,i,c,"next",e)}function c(e){L(a,n,o,i,c,"throw",e)}i(void 0)}))},function(e){return r.apply(this,arguments)}),getIdentity:function(){var e=localStorage.getItem("token");if(e){var t=function(e,t){if("string"!=typeof e)throw new H("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(M(e.split(".")[r]))}catch(e){throw new H("Invalid token specified: "+e.message)}}(e);return{id:t.webId,fullName:t.name}}}}},z=function(t){var r=t.basePath,n=t.className,c=t.data,l=t.hasList,s=t.hasShow,u=$(t,["basePath","className","data","hasList","hasShow"]);return e.createElement(o,W({className:n},u),l&&e.createElement(a,{basePath:r,record:c}),s&&e.createElement(i,{basePath:r,record:c}))},B=k((function(){return{toolbar:{flex:1,display:"flex",justifyContent:"space-between"}}})),F=function(t){var r=t.hasDelete,n=$(t,["hasDelete"]),o=B();return e.createElement(c,W({},n,{className:o.toolbar}),e.createElement(l,null),r&&e.createElement(s,{undoable:!1}))},G=["acl:Read","acl:Append","acl:Write","acl:Control"],K=["acl:Append","acl:Write","acl:Control"],Q=["acl:Append","acl:Write","acl:Control"],X=["acl:Write","acl:Control"],Y=function(t){var r=u(t.id),n=r.loaded,o=r.permissions;return e.createElement(m,W({actions:e.createElement(z,null)},t,{permissions:o}),e.cloneElement(t.children,{toolbar:e.createElement(F,{hasDelete:n&&o.some((function(e){return X.includes(e)}))})}))},Z=j((function(e){return{main:{display:"flex",flexDirection:"column",minHeight:"100vh",alignItems:"center",justifyContent:"flex-start",backgroundColor:e.palette.primary[500]},card:{minWidth:300,marginTop:"6em"},lockIconAvatar:{margin:"1em",display:"flex",justifyContent:"center"},lockIcon:{backgroundColor:e.palette.secondary[500]}}})),ee=function(e){var n=e.theme,o=e.history,a=e.location,i=e.buttons,c=Z(),l=f(),s=d(),u=new URLSearchParams(a.search);return u.has("token")&&(localStorage.setItem("token",u.get("token")),l("Vous êtes maintenant connecté","info"),o.push("/")),u.has("logout")&&(localStorage.removeItem("token"),l("Vous êtes maintenant déconnecté","info"),o.push("/")),t(S,{theme:U(n)},t("div",{className:c.main},t(C,{className:c.card},t("div",{className:c.lockIconAvatar},t(I,{className:c.lockIcon},t(N,null))),i&&i.map((function(e){return t(P,null,r(e,{fullWidth:!0,variant:"outlined",type:"submit",onClick:function(){return s({},"/login")}}))})))),t(p,null))};ee.defaultProps={buttons:[t(x,{startIcon:t(I,{src:"/lescommuns.jpg"})},"Les Communs")]};var te=n((function(t,r){var n=h();return e.createElement(O,{onClick:function(){return n()},ref:r},e.createElement(R,null),"   Se déconnecter")})),re=function(t){var r=t.name,n=t.list,o=t.create,a=$(t,["name","list","create"]),i=u(r).permissions;return e.createElement(g,W({},a,{name:r,list:i&&i.some((function(e){return G.includes(e)}))?n:void 0,create:i&&i.some((function(e){return K.includes(e)}))?o:void 0}))},ne=function(t){var r=t.basePath,n=t.className,i=t.data,c=t.hasList,l=t.hasEdit,s=$(t,["basePath","className","data","hasList","hasEdit"]);return e.createElement(o,W({className:n},s),c&&e.createElement(a,{basePath:r,record:i}),l&&e.createElement(v,{basePath:r,record:i}))},oe=function(t){var r=u(t.id),n=r.loaded,o=r.permissions;return e.createElement(w,W({actions:e.createElement(ne,null)},t,{permissions:o,hasEdit:n&&o.some((function(e){return Q.includes(e)}))}))},ae=n((function(t,r){var n=t.onClick,o=t.webId;return e.createElement(y,{ref:r,to:"/Person/".concat(encodeURIComponent(o),"/show"),primaryText:"Voir mon profil",leftIcon:e.createElement(T,null),onClick:n})})),ie=n((function(t,r){var n=t.onClick,o=t.webId;return e.createElement(y,{ref:r,to:"/Person/".concat(encodeURIComponent(o),"/edit"),primaryText:"Editer mon profil",leftIcon:e.createElement(A,null),onClick:n})})),ce=n((function(t,r){var n=t.onClick;return e.createElement(y,{ref:r,to:"/login",primaryText:"Se connecter",onClick:n})})),le=function(t){var r=t.logout,n=$(t,["logout"]),o=b().identity;return e.createElement(E,n,o&&""!==o.id?[e.createElement(ae,{webId:o.id,key:"view"}),e.createElement(ie,{webId:o.id,key:"edit"}),e.cloneElement(r,{key:"logout"})]:e.createElement(ce,null))};export{z as EditActions,Y as EditWithPermissions,ee as LoginPage,te as LogoutButton,re as ResourceWithPermissions,ne as ShowActions,oe as ShowWithPermissions,le as UserMenu,q as authProvider};
