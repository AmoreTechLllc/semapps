import e,{createElement as t,cloneElement as n,forwardRef as r,useState as o,useEffect as a,useMemo as i}from"react";import{TopToolbar as l,ListButton as c,ShowButton as u,Toolbar as s,SaveButton as m,DeleteButton as f,usePermissionsOptimized as d,Edit as p,useNotify as h,useLogin as g,Notification as y,useLogout as v,Resource as b,useDataProvider as E,Loading as w,Error as k,Button as C,EditButton as P,Show as I,MenuItemLink as O,useGetIdentity as j,UserMenu as S}from"react-admin";import{makeStyles as A,Card as x,Avatar as N,CardActions as U,Button as T,ListItem as R,ListItemAvatar as L,ListItemText as W,ListItemSecondaryAction as D,IconButton as $,Menu as M,MenuItem as F,ListItemIcon as B,List as V,Dialog as G,DialogTitle as H,DialogContent as J,TextField as _,DialogActions as q}from"@material-ui/core";import z from"@material-ui/icons/Public";import K from"@material-ui/icons/VpnLock";import Q from"@material-ui/icons/Person";import X from"@material-ui/icons/Group";import{ThemeProvider as Y}from"@material-ui/styles";import{makeStyles as Z,createMuiTheme as ee}from"@material-ui/core/styles";import te from"@material-ui/icons/Lock";import ne from"@material-ui/core/MenuItem";import re from"@material-ui/icons/PowerSettingsNew";import oe from"@material-ui/icons/Share";import ae from"@material-ui/icons/Edit";import ie from"@material-ui/icons/Check";import le from"@material-ui/icons/AccountCircle";function ce(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function ue(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function se(){return(se=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function me(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function fe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?me(Object(n),!0).forEach((function(t){ue(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):me(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function de(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function pe(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,o=!1,a=void 0;try{for(var i,l=e[Symbol.iterator]();!(r=(i=l.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(o)throw a}}return n}(e,t)||he(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function he(e,t){if(e){if("string"==typeof e)return ge(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ge(e,t):void 0}}function ge(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ye(e){this.message=e}ye.prototype=new Error,ye.prototype.name="InvalidCharacterError";var ve="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new ye("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,r,o=0,a=0,i="";r=t.charAt(a++);~r&&(n=o%4?64*n+r:r,o++%4)?i+=String.fromCharCode(255&n>>(-2*o&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return i};function be(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(ve(e).replace(/(.)/g,(function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n})))}(t)}catch(e){return ve(t)}}function Ee(e){this.message=e}Ee.prototype=new Error,Ee.prototype.name="InvalidTokenError";var we="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var ke,Ce=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,n;t=we,n=function(){function e(e){var t=[];if(0===e.length)return"";if("string"!=typeof e[0])throw new TypeError("Url must be a string. Received "+e[0]);if(e[0].match(/^[^/:]+:\/*$/)&&e.length>1){var n=e.shift();e[0]=n+e[0]}e[0].match(/^file:\/\/\//)?e[0]=e[0].replace(/^([^/:]+):\/*/,"$1:///"):e[0]=e[0].replace(/^([^/:]+):\/*/,"$1://");for(var r=0;r<e.length;r++){var o=e[r];if("string"!=typeof o)throw new TypeError("Url must be a string. Received "+o);""!==o&&(r>0&&(o=o.replace(/^[\/]+/,"")),o=r<e.length-1?o.replace(/[\/]+$/,""):o.replace(/[\/]+$/,"/"),t.push(o))}var a=t.join("/"),i=(a=a.replace(/\/(\?|&|#[^!])/g,"$1")).split("?");return a=i.shift()+(i.length>0?"?":"")+i.join("&")}return function(){return e("object"==typeof arguments[0]?arguments[0]:[].slice.call(arguments))}},e.exports?e.exports=n():t.urljoin=n()})),Pe=function(e){var t,n,r=e.middlewareUri,o=e.httpClient,a=e.checkPermissions,i=e.resources;return{login:function(e){return window.location.href="".concat(r,"auth?redirectUrl=")+encodeURIComponent(window.location.href),Promise.resolve()},logout:function(){var e=new URL(window.location.href);return window.location.href="".concat(r,"auth/logout?redirectUrl=")+encodeURIComponent(e.origin+"/login?logout"),Promise.resolve("/")},checkAuth:function(){return localStorage.getItem("token"),Promise.resolve()},checkError:function(e){return Promise.resolve()},getPermissions:(t=regeneratorRuntime.mark((function e(t){var n,l,c,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a){e.next=2;break}return e.abrupt("return",!0);case 2:return n=i[t]?i[t].containerUri:t,l=Ce(r,n.replace(r,"_acl/")),e.next=6,o(l);case 6:return c=e.sent,u=c.json,e.abrupt("return",u["@graph"]);case 9:case"end":return e.stop()}}),e)})),n=function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(e){ce(a,r,o,i,l,"next",e)}function l(e){ce(a,r,o,i,l,"throw",e)}i(void 0)}))},function(e){return n.apply(this,arguments)}),getIdentity:function(){var e=localStorage.getItem("token");if(e){var t=function(e,t){if("string"!=typeof e)throw new Ee("Invalid token specified");var n=!0===(t=t||{}).header?0:1;try{return JSON.parse(be(e.split(".")[n]))}catch(e){throw new Ee("Invalid token specified: "+e.message)}}(e);return{id:t.webId,fullName:t.name}}}}},Ie=function(t){var n=t.basePath,r=t.className,o=t.data,a=t.hasList,i=t.hasShow,s=de(t,["basePath","className","data","hasList","hasShow"]);return e.createElement(l,se({className:r},s),a&&e.createElement(c,{basePath:n,record:o}),i&&e.createElement(u,{basePath:n,record:o}))},Oe=A((function(){return{toolbar:{flex:1,display:"flex",justifyContent:"space-between"}}})),je=function(t){var n=t.hasDelete,r=de(t,["hasDelete"]),o=Oe();return e.createElement(s,se({},r,{className:o.toolbar}),e.createElement(m,null),n&&e.createElement(f,{undoable:!1}))},Se=["acl:Read","acl:Append","acl:Write","acl:Control"],Ae=["acl:Append","acl:Write","acl:Control"],xe=["acl:Append","acl:Write","acl:Control"],Ne=["acl:Write","acl:Control"],Ue=["acl:Control"],Te=(ue(ke={},"acl:Read","Lire"),ue(ke,"acl:Append","Enrichir"),ue(ke,"acl:Write","Modifier"),ue(ke,"acl:Control","Administrer"),ke),Re={anon:{label:"Tous les utilisateurs",icon:e.createElement(z,null)},anyUser:{label:"Utilisateurs connectés",icon:e.createElement(K,null)},user:{icon:e.createElement(Q,null)},group:{icon:e.createElement(X,null)}},Le=function(t){var n=d(t.id).permissions;return e.createElement(p,se({actions:e.createElement(Ie,null)},t,{permissions:n}),e.cloneElement(t.children,{toolbar:e.createElement(je,{hasDelete:n&&n.some((function(e){return Ne.includes(e["acl:mode"])}))})}))},We=Z((function(e){return{main:{display:"flex",flexDirection:"column",minHeight:"100vh",alignItems:"center",justifyContent:"flex-start",backgroundColor:e.palette.primary[500]},card:{minWidth:300,marginTop:"6em"},lockIconAvatar:{margin:"1em",display:"flex",justifyContent:"center"},lockIcon:{backgroundColor:e.palette.secondary[500]}}})),De=function(e){var r=e.theme,o=e.history,a=e.location,i=e.buttons,l=We(),c=h(),u=g(),s=new URLSearchParams(a.search);return s.has("token")&&(localStorage.setItem("token",s.get("token")),c("Vous êtes maintenant connecté","info"),o.push("/")),s.has("logout")&&(localStorage.removeItem("token"),c("Vous êtes maintenant déconnecté","info"),o.push("/")),t(Y,{theme:ee(r)},t("div",{className:l.main},t(x,{className:l.card},t("div",{className:l.lockIconAvatar},t(N,{className:l.lockIcon},t(te,null))),i&&i.map((function(e){return t(U,null,n(e,{fullWidth:!0,variant:"outlined",type:"submit",onClick:function(){return u({},"/login")}}))})))),t(y,null))};De.defaultProps={buttons:[t(T,{startIcon:t(N,{src:"/lescommuns.jpg"})},"Les Communs")]};var $e=r((function(t,n){var r=v();return e.createElement(ne,{onClick:function(){return r()},ref:n},e.createElement(re,null),"   Se déconnecter")})),Me=function(t){var n=t.name,r=t.list,o=t.create,a=de(t,["name","list","create"]),i=d(n).permissions;return e.createElement(b,se({},a,{name:n,list:i&&i.some((function(e){return Se.includes(e["acl:mode"])}))?r:void 0,create:i&&i.some((function(e){return Ae.includes(e["acl:mode"])}))?o:void 0}))},Fe=A((function(){return{listItem:{paddingLeft:4,paddingRight:36},secondaryText:{textAlign:"center",width:"50%",fontStyle:"italic",color:"grey"}}})),Be=function(t){var n=t.agent,r=Fe(),i=E(),l=pe(e.useState(null),2),c=l[0],u=l[1],s=pe(o(),2),m=s[0],f=s[1],d=pe(o(!0),2),p=d[0],h=d[1],g=pe(o(),2),y=g[0],v=g[1];if(a((function(){"user"===n.type?i.getOne("Person",{id:n.id}).then((function(e){var t=e.data;f(t),h(!1)})).catch((function(e){v(e),h(!1)})):h(!1)}),[n.id,n.type]),"group"===n.type)return null;var b=function(){return u(null)};return p?e.createElement(w,null):y?e.createElement(k,null):e.createElement(R,{button:!0,className:r.listItem},e.createElement(L,null,e.createElement(N,{src:null==m?void 0:m.image},n.icon)),e.createElement(W,{primary:n.label||(null==m?void 0:m.name)}),e.createElement(W,{className:r.secondaryText,primary:n.permissions&&n.permissions.map((function(e){return Te[e]})).join(", ")}),e.createElement(D,null,e.createElement($,{onClick:function(e){return u(e.currentTarget)}},e.createElement(ae,null)),e.createElement(M,{anchorEl:c,keepMounted:!0,open:Boolean(c),onClose:b},Object.entries(Te).map((function(t){var r=pe(t,2),o=r[0],a=r[1];return e.createElement(F,{onClick:b},e.createElement(B,null,n.permissions&&n.permissions.includes(o)?e.createElement(ie,null):null),e.createElement(W,{primary:a}))})))))},Ve=A((function(e){return{list:{width:"100%",maxWidth:"100%",backgroundColor:e.palette.background.paper}}})),Ge=function(e){return e?Array.isArray(e)?e:[e]:void 0},He=function(e,t){return Array.isArray(e["acl:agentClass"])?e["acl:agentClass"].includes(t):e["acl:agentClass"]===t},Je=function(e,t,n,r){e[t]?e[t].permissions.push(r):e[t]=fe(fe({id:t,type:n},Re[n]),{},{permissions:[r]})},_e=function(t){var n=t.record,r=Ve(),o=d(n.id).permissions,a=i((function(){var e,t={},n=function(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=he(e))){var t=0,n=function(){};return{s:n,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,a=!0,i=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){i=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(i)throw o}}}}(o);try{var r=function(){var n=e.value;He(n,"foaf:Agent")&&Je(t,"foaf:Agent","anon",n["acl:mode"]),He(n,"acl:AuthenticatedAgent")&&Je(t,"acl:AuthenticatedAgent","anyUser",n["acl:mode"]),n["acl:agent"]&&Ge(n["acl:agent"]).forEach((function(e){return Je(t,e,"user",n["acl:mode"])})),n["acl:agentGroup"]&&Ge(n["acl:agentGroup"]).forEach((function(e){return Je(t,e,"group",n["acl:mode"])}))};for(n.s();!(e=n.n()).done;)r()}catch(e){n.e(e)}finally{n.f()}return t}),[o]);return e.createElement(V,{dense:!0,className:r.list},Object.entries(a).map((function(t){var n=pe(t,2),r=n[0],o=n[1];return e.createElement(Be,{key:r,agent:o})})))},qe=A((function(){return{title:{paddingBottom:8},actions:{padding:15},addForm:{paddingTop:0},listForm:{paddingTop:0,paddingBottom:0,paddingRight:0,maxHeight:200}}})),ze=function(t){var n=t.record,r=qe(),a=pe(o(!1),2),i=a[0],l=a[1];return e.createElement(e.Fragment,null,e.createElement(C,{label:"Permissions",onClick:function(){return l(!0)}},e.createElement(oe,null)),e.createElement(G,{fullWidth:!0,open:i,onClose:function(){return l(!1)}},e.createElement(H,{className:r.title},"Permissions sur la ressource"),e.createElement(J,{className:r.addForm},e.createElement(_,{label:"Ajouter un utilisateur ou un groupe...",variant:"filled",margin:"dense",fullWidth:!0})),e.createElement(J,{className:r.listForm},e.createElement(_e,{record:n})),e.createElement(q,{className:r.actions},e.createElement(C,{label:"ra.action.close",variant:"inlined",onClick:function(){return l(!1)}}))))},Ke=function(t){var n=t.basePath,r=t.className,o=t.data,a=t.hasList,i=t.hasEdit,u=t.hasControl,s=de(t,["basePath","className","data","hasList","hasEdit","hasControl"]);return e.createElement(l,se({className:r},s),a&&e.createElement(c,{basePath:n,record:o}),i&&e.createElement(P,{basePath:n,record:o}),u&&e.createElement(ze,{basePath:n,record:o}))},Qe=function(t){var n=d(t.id).permissions;return e.createElement(I,se({actions:e.createElement(Ke,{hasControl:n&&n.some((function(e){return Ue.includes(e["acl:mode"])}))})},t,{permissions:n,hasEdit:n&&n.some((function(e){return xe.includes(e["acl:mode"])}))}))},Xe=r((function(t,n){var r=t.onClick,o=t.webId;return e.createElement(O,{ref:n,to:"/Person/".concat(encodeURIComponent(o),"/show"),primaryText:"Voir mon profil",leftIcon:e.createElement(le,null),onClick:r})})),Ye=r((function(t,n){var r=t.onClick,o=t.webId;return e.createElement(O,{ref:n,to:"/Person/".concat(encodeURIComponent(o),"/edit"),primaryText:"Editer mon profil",leftIcon:e.createElement(ae,null),onClick:r})})),Ze=r((function(t,n){var r=t.onClick;return e.createElement(O,{ref:n,to:"/login",primaryText:"Se connecter",onClick:r})})),et=function(t){var n=t.logout,r=de(t,["logout"]),o=j().identity;return e.createElement(S,r,o&&""!==o.id?[e.createElement(Xe,{webId:o.id,key:"view"}),e.createElement(Ye,{webId:o.id,key:"edit"}),e.cloneElement(n,{key:"logout"})]:e.createElement(Ze,null))};export{Ie as EditActions,Le as EditWithPermissions,De as LoginPage,$e as LogoutButton,Me as ResourceWithPermissions,Ke as ShowActions,Qe as ShowWithPermissions,et as UserMenu,Pe as authProvider};
